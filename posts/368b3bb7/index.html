<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ | snovving</title><meta name="keywords" content="SSRF,Apache,mod_proxy"><meta name="author" content="snovving"><meta name="copyright" content="snovving"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="å®‰å…¨å®¢æŠ•ç¨¿çš„ç¬¬å››ç¯‡ï¼Œå¹´æœ«ç²¾ç¥ä¸å¤ªå¥½ï¼Œæ‹–å»¶åˆ° 12 æœˆ 15 å·æ‰å®Œæˆï¼Œä»¥æ­¤è‡ªçœã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ">
<meta property="og:url" content="https://snovving.top/posts/368b3bb7/index.html">
<meta property="og:site_name" content="snovving">
<meta property="og:description" content="å®‰å…¨å®¢æŠ•ç¨¿çš„ç¬¬å››ç¯‡ï¼Œå¹´æœ«ç²¾ç¥ä¸å¤ªå¥½ï¼Œæ‹–å»¶åˆ° 12 æœˆ 15 å·æ‰å®Œæˆï¼Œä»¥æ­¤è‡ªçœã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-11-21T11:30:00.000Z">
<meta property="article:modified_time" content="2021-12-28T13:30:09.444Z">
<meta property="article:author" content="snovving">
<meta property="article:tag" content="SSRF">
<meta property="article:tag" content="Apache">
<meta property="article:tag" content="mod_proxy">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/snow.png"><link rel="canonical" href="https://snovving.top/posts/368b3bb7/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":150,"languages":{"author":"ä½œè€…: snovving","link":"é“¾æ¥: ","source":"æ¥æº: snovving","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-12-28 21:30:09'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="snovving" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://blog-img-1308029004.cos.ap-shanghai.myqcloud.com/1640695032538.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">14</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹äººå¸</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">snovving</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹äººå¸</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2021-11-21T11:30:00.000Z" title="å‘è¡¨äº 2021-11-21 19:30:00">2021-11-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2021-12-28T13:30:09.444Z" title="æ›´æ–°äº 2021-12-28 21:30:09">2021-12-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">æ¼æ´å¤ç°</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">Cä»£ç å®¡è®¡</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><blockquote><p>æ–‡ç« é¦–å‘äºå®‰å…¨å®¢ã€‚</p>
</blockquote>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¤ç°è¿™ä¸ªæ¼æ´çš„è¿‡ç¨‹ä¸­è§‰å¾—å¾ˆæœ‰åˆ†æçš„å¿…è¦ï¼Œè€Œä½œè€…æºç ç»“åˆ log è°ƒè¯•åˆ†æçš„<a target="_blank" rel="noopener external nofollow noreferrer" href="https://firzen.de/building-a-poc-for-cve-2021-40438">è¿™ç¯‡æ–‡ç« </a>å·²ç»å†™å¾—æ¯”è¾ƒè¯¦å°½äº†ï¼Œå°±æƒ³è‡ªå·±çº¯ä»å®¡è®¡çš„è§’åº¦å†™ä¸€ä¸‹åˆ†æå·©å›ºä¸€ä¸‹ã€‚</p>
<p>æ€»ä¹‹ï¼Œå¦‚æœ‰ä¸å½“ï¼Œçƒ¦è¯·è¯„è®ºæ‰è™«ï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æ—¶é—´å“åº”å¹¶è¯„è®ºæç¤ºï¼Œè°¢è°¢ã€‚</p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211209084402856.png" alt="image-20211209084402856" style="zoom:80%;" />

<p>å¯æ„é€  uri ä½¿ mod_proxy è¯·æ±‚è½¬å‘ç»™å†…éƒ¨æœåŠ¡å™¨é€ æˆ SSRF ã€‚</p>
<h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121200332290.png" alt="image-20211121200332290" style="zoom: 80%;" />

<h3 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h3><p>ä»£å®¡ç¯èŠ‚ä¸ªäººå»ºè®®æ˜¯äº²æ‰‹ç¼–è¯‘è°ƒè¯• Apache è·Ÿè¿›ï¼Œå¯ä»¥å‚ç…§ P ç¥çš„æ•™ç¨‹ï¼š</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://wx.zsxq.com/dweb2/index/topic_detail/418885442584848">ç¼–è¯‘è°ƒè¯• Apache</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://wx.zsxq.com/dweb2/index/topic_detail/218882521544551">è°ƒè¯•è¡¥å……äº‹é¡¹</a></p>
<p>ä¸ä¸€å®šè¦ Ubantuï¼ŒKali ä¸Šç¬”è€…ä¹Ÿè°ƒè¯•æˆåŠŸäº†ï¼Œæœ€å¥½ç”¨ VSï¼Œå¦å¤–å¦‚æœä½ æƒ³å°è¯•ç”¨ CLionï¼Œå¯ä»¥å‚ç…§ä¸‹é¢çš„é“¾æ¥è¿›è¡Œ SSH è¿œç¨‹è°ƒè¯•ï¼Œå…¶ä½™æ­¥éª¤éƒ½åŒä¸Šä¸€æ ·ï¼š</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.jetbrains.com/clion/2018/09/initial-remote-dev-support-clion/">Stay local, let your IDE do remote work for you! | The CLion Blog (jetbrains.com)</a></p>
<p>CLion è°ƒè¯•éœ€è¦æ³¨æ„æœ‰ cmake å’Œ gdb ç‰ˆæœ¬é™åˆ¶ï¼Œæœ€å¥½ä¸è¦ä¸‹è½½æœ€æ–°ç‰ˆæœ¬é¿å…è¿˜è¦ç”¨è½¯é“¾æ¥é‡æ–°ä¸‹è½½æŸä¸€æŒ‡å®šç‰ˆæœ¬ï¼Œæˆ–è€…æ›´æ–° CLion ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<h2 id="å‰ç½®å­¦ä¹ "><a href="#å‰ç½®å­¦ä¹ " class="headerlink" title="å‰ç½®å­¦ä¹ "></a>å‰ç½®å­¦ä¹ </h2><p>ä¸ºäº†ç†è§£æ¼æ´åŸç†ï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºæ˜¯éœ€è¦ Apache å’Œ PHP ä¸€äº›å‰ç½®çŸ¥è¯†å­¦ä¹ çš„ï¼Œå°±ç®€å•æ¦‚æ‹¬äº†å¹¶ä½¿ä¹‹é€’è¿›åŠ æ·±ç†è§£ï¼Œå¾ˆå¤šç‚¹éƒ½ä¼šåœ¨åˆ†æè¿‡ç¨‹ä¸­ç”¨åˆ°ï¼Œè¡Œæ–‡ç»“åˆäº†è®¸å¤šå®˜æ–¹æ–‡æ¡£å’Œè‡ªèº«ç†è§£æ•´ç†ä»¥ç¡®ä¿å‡†ç¡®ï¼Œå¦‚æœ‰ç¼ºæ¼ä¸å½“ä¹‹å¤„ï¼Œè¿˜è¯·æŒ‡å‡ºã€‚</p>
<h3 id="Apache-éƒ¨ç½²-php"><a href="#Apache-éƒ¨ç½²-php" class="headerlink" title="Apache éƒ¨ç½² php"></a>Apache éƒ¨ç½² php</h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œphp æœ‰äº”ç§è¿è¡Œæ¨¡å¼ï¼Œå…¶ä¸­æœ€å¸¸è§çš„ä¸‰ç§ CGIã€FastCGIã€Module åŠ è½½æˆ–è€…è¯´ apache2handler æ›´ä¸ºæ°å½“ï¼ˆlinux ä¸‹ï¼‰ã€‚</p>
<p>Module åŠ è½½è¿™ç§æ¨¡å¼ä¸€èˆ¬å¯¹äº Apache è€Œè¨€ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠ PHP ä½œä¸º Apache çš„ä¸€ä¸ªå­æ¨¡å—æ¥è¿è¡Œï¼Œç”¨ LoadModule åŠ è½½æ¨¡å—ï¼Œæœ€ä¸»è¦çš„æ¨¡å—å°±æ˜¯ mod_phpï¼Œæ¼æ´å®éªŒç¯å¢ƒé…ç½®è°ƒè¯•ä¹Ÿæ˜¯ä»¥ LoadModule åŠ è½½ mod_proxy çš„ã€‚</p>
<p>è€Œ FastCGI è¿™ä¸ªæ¨¡å¼ä¸‹ä¼šç”¨åˆ° PHP-FPM è¿™ä¸ªè¿›ç¨‹ç®¡ç†å™¨è¿›è¡Œ FastCGI ç®¡ç†ï¼Œè€Œé CGI çš„ç”¨ Web æœåŠ¡å™¨ç®¡ç†ï¼Œå…¶ä¸­çš„å­è¿›ç¨‹å«åš PHP-CGI ï¼Œ<strong>è¿™æ¬¡æ¼æ´çš„çªç ´ç‚¹ mod_proxy å°±ä¸ PHP-FPM æœ‰å…³ï¼Œå®ƒä» PHP 5.3.3 å°±æˆä¸ºäº† PHP çš„å†…ç½®ç®¡ç†å™¨ï¼Œæ‰€ä»¥é…åˆè¿™ä¸ªä» Apache httpd 2.4.x æ¨å‡ºäº†ä½¿ç”¨ mod_proxy çš„å­æ¨¡å— mod_proxy_fcgi å’Œ PHP-FPM éƒ¨ç½²æ›´é«˜æ€§èƒ½çš„ PHP è¿è¡Œç¯å¢ƒã€‚</strong></p>
<p>è™½ç„¶ç°åœ¨æ˜æ˜¾ç”¨ Nginx+PHP-FPM æ˜¯æ›´å¥½çš„é€‰æ‹© :-)</p>
<h3 id="mod-proxy-åå‘ä»£ç†"><a href="#mod-proxy-åå‘ä»£ç†" class="headerlink" title="mod_proxy åå‘ä»£ç†"></a>mod_proxy åå‘ä»£ç†</h3><p>é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ¨¡å—ä¸å…¶ç›¸å…³æ¨¡å—ä¸º Apache HTTP Server å®ç°ä»£ç† / ç½‘å…³ã€‚</p>
<p>å‰é¢æœ‰è¯´åˆ° High-performance PHP on apache httpd 2.4.x using mod_proxy_fcgi and php-fpm è¿™ç§æ–¹å¼ï¼Œæœ¬è´¨å°±æ˜¯ Apache ä½œä¸ºåä»£æœåŠ¡å™¨ç”¨ mod_proxy_fcgi è¿™ä¸ªå­æ¨¡å—è¯·æ±‚è½¬å‘ç»™ PHP-FPM ï¼Œè€Œ PHP-FPM ç›‘å¬çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶ Apache è½¬è¿‡å»æ—¶å¤„ç† PHP çš„è¯·æ±‚çš„æ–¹å¼ï¼Œæœ‰ä¸¤ç§ï¼š</p>
<ol>
<li><p>TCP Socketï¼ˆip and portï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProxyPass / http://www.example.com:port</span><br></pre></td></tr></table></figure></li>
<li><p>UDS ï¼ˆUnix Domain Socketï¼‰ </p>
<p><strong>åªåœ¨Apache 2.4.7 åŠæ›´é«˜ç‰ˆæœ¬ä¸­æ”¯æŒã€‚</strong></p>
<p>å¯ä»¥é€šè¿‡ä½¿ç”¨ä½äº <code>unix:/path/app.sock|</code> å‰é¢çš„ç›®æ ‡æ¥æ”¯æŒä½¿ç”¨ UDS ã€‚ä¾‹å¦‚ï¼Œè¦ä»£ç† HTTP å¹¶å°† UDS å®šä½äº /home/<a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.socket/">www.socket</a> ï¼Œåº”ä½¿ç”¨ <code>unix:/home/www.socket|http://localhost/whatever/</code> ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProxyPass / unix:/path/to/app.sock|http://example.com/app/name</span><br></pre></td></tr></table></figure></li>
</ol>
<p>å¯¹äºåå‘ä»£ç†è€Œè¨€ï¼Œ Apache è½¬å‘ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ Apache å‘é€è¯·æ±‚ç»™ PHP-FPM çš„æ–¹å¼æœ‰ä¸‰ç§ï¼Œå…¶ä¸­ä¸€ç§å« ProxyPass ï¼Œè¿™æ˜¯æŒ‡ä»¤ï¼Œå…è®¸å°†è¿œç¨‹æœåŠ¡å™¨ Map åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼ˆåå‘ä»£ç† / ç½‘å…³ï¼‰çš„ç©ºé—´ï¼Œå¯¹äºä¸åŒç›‘å¬æ–¹å¼çš„æŒ‡ä»¤ä¾‹å­å¦‚ä¸Šæ‰€ç¤ºã€‚</p>
<h3 id="Apache-hook-æœºåˆ¶"><a href="#Apache-hook-æœºåˆ¶" class="headerlink" title="Apache hook æœºåˆ¶"></a>Apache hook æœºåˆ¶</h3><p>è¯´èµ· Apache Module ä¸èƒ½ä¸æèµ· Apache hookï¼Œæƒ³è¦å¤„ç†è¯·æ±‚ï¼Œè¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­åˆ›å»ºä¸€ä¸ª hookï¼Œæ‰€æœ‰å¤„ç†ç¨‹åºï¼Œå°±æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢è¯´åˆ°çš„ mod_proxy ï¼Œéƒ½ä¼šè¢«æŒ‚æ¥åˆ°è¯·æ±‚è¿‡ç¨‹çš„ç‰¹å®šéƒ¨åˆ†ã€‚æœåŠ¡å™¨æœ¬èº«æ˜¯ä¸çŸ¥é“å“ªä¸ªæ¨¡å—è´Ÿè´£å¤„ç†ç‰¹å®šè¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¼šè¯¢é—®æ¯ä¸ªæ¨¡å—æ˜¯å¦å¯¹ç»™å®šè¯·æ±‚æ„Ÿå…´è¶£ã€‚ç„¶åï¼Œç”±æ¯ä¸ªæ¨¡å—å†³å®šæ˜¯å¦åƒèº«ä»½éªŒè¯ / æˆæƒæ¨¡å—é‚£æ ·æ‹’ç»æœåŠ¡è¯·æ±‚ï¼Œæ¥å—æœåŠ¡è¯·æ±‚æˆ–æ‹’ç»æœåŠ¡è¯·æ±‚ï¼Œå°±åƒä¸‹å›¾ä¸€æ ·ã€‚</p>
<img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211214095139626.png" alt="image-20211214095139626" style="zoom:80%;" />

<p>ä¸ºäº†ä½¿è¯¸å¦‚ mod_example ä¹‹ç±»çš„å¤„ç†ç¨‹åºæ›´å®¹æ˜“çŸ¥é“ Client ç«¯æ˜¯å¦åœ¨è¯·æ±‚æˆ‘ä»¬åº”å¤„ç†çš„å†…å®¹ï¼ŒæœåŠ¡å™¨å…·æœ‰ç”¨äºå‘æ¨¡å—æç¤ºæ˜¯å¦éœ€è¦å…¶ååŠ©çš„æŒ‡ä»¤ã€‚å…¶ä¸­ä¸¤ä¸ªæ˜¯ <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-mod_mime.html#addhandler">AddHandler</a> å’Œ <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-core.html#sethandler">SetHandler</a>ã€‚</p>
<p>ä¸ºæ­¤å¯ä»¥çœ‹ä¸€ä¸ªä¾‹å­ç†è§£ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³é€šè¿‡åˆ›å»ºåˆé€‚çš„ Handler ä¼ é€’ï¼Œå°†è¯·æ±‚å¼ºåˆ¶å¤„ç†ä¸ºåå‘ä»£ç†è¯·æ±‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;\.php$&quot;&gt;</span><br><span class="line">    # Unix sockets require 2.4.7 or later</span><br><span class="line">    SetHandler  &quot;proxy:unix:/path/to/app.sock|fcgi://localhost/&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­æ˜¯ä½¿ç”¨åå‘ä»£ç†å°†å¯¹ PHP è„šæœ¬çš„æ‰€æœ‰è¯·æ±‚ä¼ é€’åˆ°æŒ‡å®šçš„ FastCGI æœåŠ¡å™¨ï¼Œæ˜¯ä¸æ˜¯å’Œä¹‹å‰ UDS çš„ä¾‹å­å¾ˆåƒï¼Ÿ</p>
<p>ä¸€ä¸ª Module é€šå¸¸æ˜¯åœ¨ Handler ä¸­åˆ›å»ºä¸€ä¸ª hookï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">register_hooks</span><span class="params">(<span class="keyword">apr_pool_t</span> *pool)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Create a hook in the request handler, so we get called when a request arrives */</span></span><br><span class="line">    ap_hook_handler(example_handler, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_LAST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šï¼Œç»§è€Œå°±ä¼šåœ¨ example_handler è¿™ä¸ªå‡½æ•°ä¸­å¤„ç†è¯·æ±‚ï¼Œmod_proxy ä¹Ÿæœ‰è¿™æ ·çš„ Handler ã€‚</p>
<p>å¦å¤–è¿˜è¦æåˆ°çš„å°±æ˜¯ request_rec ç»“æ„ã€‚</p>
<p>ä»»ä½•è¯·æ±‚ä¸­æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ request record ã€‚åœ¨å¯¹å¤„ç†ç¨‹åºå‡½æ•°çš„è°ƒç”¨ä¸­ï¼Œè¿™ç”±ä¸è¿›è¡Œçš„æ¯æ¬¡è°ƒç”¨ä¸€èµ·ä¼ é€’çš„ <code>request_rec*</code> ç»“æ„è¡¨ç¤ºã€‚è¯¥ç»“æ„åœ¨æ¨¡å—ä¸­é€šå¸¸ç®€ç§°ä¸º <code>r</code> ï¼ŒåŒ…å«æ¨¡å—å®Œå…¨å¤„ç†ä»»ä½• HTTP è¯·æ±‚å¹¶ç›¸åº”åšå‡ºå“åº”æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p>
<img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211214102827262.png" alt="image-20211214102827262" style="zoom:80%;" />

<p>å…¶ä¸­è¿™ä¸ª <code>r-&gt;filename</code> è¿˜æœ‰å…¶ä»–å‡ ä¸ªæˆ‘ä»¬å°±ä¼šåœ¨åˆ†æè¿‡ç¨‹ä¸­æ¥è§¦åˆ°ã€‚</p>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="ä»£ç å®¡è®¡"><a href="#ä»£ç å®¡è®¡" class="headerlink" title="ä»£ç å®¡è®¡"></a>ä»£ç å®¡è®¡</h3><p>ä»¥ Apache 2.4.48 æºä»£ç å®¡è®¡ï¼Œ<strong>ä¸åŒç‰ˆæœ¬ä¼šæœ‰äº›å‡ºå…¥</strong>ã€‚</p>
<p><strong>æ³¨æ„å®¡è®¡è¿™éƒ¨åˆ†ç€é‡çœ‹ä»£ç ä¸­çš„æ³¨é‡Šï¼Œç¬”è€…æ‰€å†™çš„æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†è§£é‡Šå’Œåˆ†æéƒ½åœ¨å…¶ä¸­ï¼Œä¿®å¤çš„éƒ¨åˆ†ä¼šæ ‡ * ï¼Œä¸€å®šè¦çœ‹æ³¨é‡Šé…åˆç†è§£ï¼</strong></p>
<p>[<a target="_blank" rel="noopener external nofollow noreferrer" href="https://svn.apache.org/viewvc?view=revision&revision=1892814">Apache-SVN] Revision 1892814</a></p>
<p>ç›´æ¥æ¥çœ‹ä¿®å¤å‰åçš„å¯¹æ¯”åˆ†æç¼ºé™·åœ¨å“ªï¼Œè¿˜æœ‰æ¼æ´æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆé—®é¢˜ã€‚</p>
<p>å®˜æ–¹çš„å‡½æ•°è§£é‡Šçœ‹è¿™ä¸ªæ–‡æ¡£ï¼š</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__DAEMON.html#gaa6a7169f7d3801b11d3b113b27284dbd">Apache2: HTTP Daemon Routine</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">--- httpd/httpd/trunk/modules/proxy/proxy_util.c    <span class="number">2021</span>/<span class="number">09</span>/<span class="number">02</span> <span class="number">12</span>:<span class="number">33</span>:<span class="number">49</span> <span class="number">1892813</span></span><br><span class="line">+++ httpd/httpd/trunk/modules/proxy/proxy_util.c    <span class="number">2021</span>/<span class="number">09</span>/<span class="number">02</span> <span class="number">12</span>:<span class="number">37</span>:<span class="number">02</span> <span class="number">1892814</span></span><br><span class="line">@@ <span class="number">-2274</span>,<span class="number">8</span> +<span class="number">2274</span>,<span class="number">8</span> @@ <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fix_uds_filename</span><span class="params">(request_rec *r, <span class="keyword">char</span> **url)</span></span>&#123;</span><br><span class="line">     <span class="keyword">char</span> *ptr, *ptr2;</span><br><span class="line">     <span class="keyword">if</span> (!r || !r-&gt;filename) <span class="keyword">return</span>;</span><br><span class="line">  	 </span><br><span class="line">     <span class="comment">// COND1ï¼šr-&gt;filename å‰ 6 ä¸ªå­—ç¬¦å¿…é¡»æ˜¯ proxy:</span></span><br><span class="line">     <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(r-&gt;filename, <span class="string">&quot;proxy:&quot;</span>, <span class="number">6</span>) &amp;&amp;</span><br><span class="line">             <span class="comment">// COND2ï¼šr-&gt;filename å¿…é¡»æœ‰ unix: è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œä½†ä¸åŒºåˆ†å¤§å°å†™ï¼Œè¿™ä¸åŒäº strstr</span></span><br><span class="line">-            (ptr2 = ap_strcasestr(r-&gt;filename, <span class="string">&quot;unix:&quot;</span>)) &amp;&amp;</span><br><span class="line">             <span class="comment">// COND3ï¼šCOND2 å¯¹ r-&gt;filename è¿›è¡Œäº†æˆªå–ï¼Œè¿™æ¡æ˜¯åˆ¤æ–­ unix: è¿™ä¸ªå­—ç¬¦ä¸²åçš„éƒ¨åˆ†æ˜¯å¦æœ‰ | </span></span><br><span class="line">-            (ptr = ap_strchr(ptr2, <span class="string">&#x27;|&#x27;</span>))) &#123;</span><br><span class="line">         	 <span class="comment">// *COND2ï¼šä¸åŒºåˆ†å¤§å°å†™å¯¹ä¸¤ä¸ªå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œ r-&gt;filename å¿…é¡»ä»¥ proxy:unix: å¼€å¤´</span></span><br><span class="line">+            !ap_cstr_casecmpn(r-&gt;filename + <span class="number">6</span>, <span class="string">&quot;unix:&quot;</span>, <span class="number">5</span>) &amp;&amp;</span><br><span class="line">    		 <span class="comment">// *COND3ï¼šptr2 æŒ‡ proxy:unix: åçš„éƒ¨åˆ†ï¼Œè¿™é‡Œåˆ¤æ–­å­—ç¬¦ä¸²ä¸­é‚£ä¸ªæ˜¯å¦æœ‰ | ï¼Œä¸ COND3 è¦æ±‚ä¸€è‡´</span></span><br><span class="line">+            (ptr2 = r-&gt;filename + <span class="number">6</span> + <span class="number">5</span>, ptr = ap_strchr(ptr2, <span class="string">&#x27;|&#x27;</span>))) &#123;</span><br><span class="line">    </span><br><span class="line">         <span class="keyword">apr_uri_t</span> urisock;</span><br><span class="line">         <span class="keyword">apr_status_t</span> rv;</span><br><span class="line">         *ptr = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    	 <span class="comment">// ä¸¾ä¾‹ï¼šProxyPass / unix:/path/to/app.sock|http://example.com/app/name æˆ‘ä»¬æ¥çœ‹è¿™äº›å‚æ•°çš„å€¼</span></span><br><span class="line">         <span class="comment">// è¿™é‡Œè§£æç»™å®šçš„ uri ï¼Œå¡«å†™ apr_uri_t ç»“æ„çš„ä¸€äº›å­—æ®µï¼Œé¿å…é‡å¤æå–ä¸»æœºç«¯å£ã€è·¯å¾„è¿™äº›</span></span><br><span class="line">         rv = apr_uri_parse(r-&gt;pool, ptr2, &amp;urisock);</span><br><span class="line">    	 <span class="comment">// å¦‚æœè§£ææˆåŠŸï¼ˆapr_uri_parse Returns APR_SUCCESS for success or error codeï¼‰</span></span><br><span class="line">         <span class="keyword">if</span> (rv == APR_SUCCESS) &#123;</span><br><span class="line">             <span class="comment">// è¿™é‡Œ rurl å³ redirect url åœ¨ä¾‹å­ä¸­å°±æ˜¯ http://example.com/app/nameï¼Œéœ€è¦é‡å®šå‘åˆ°çš„åœ°å€</span></span><br><span class="line">             <span class="keyword">char</span> *rurl = ptr+<span class="number">1</span>;</span><br><span class="line">             <span class="comment">// è¿”å›ç›¸å¯¹è·¯å¾„ï¼Œåœ¨ä¾‹å­ä¸­ uds_path å°±æ˜¯ /path/to/app.sock</span></span><br><span class="line">             <span class="keyword">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;pool, urisock.path);</span><br><span class="line">             <span class="comment">// å°† uds_path é”®å€¼å¯¹æ·»åŠ åˆ° r-&gt;notes</span></span><br><span class="line">             apr_table_setn(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>, sockpath);</span><br><span class="line">             *url = apr_pstrdup(r-&gt;pool, rurl); <span class="comment">/* so we get the scheme for the uds */</span></span><br><span class="line">             <span class="comment">/* r-&gt;filename starts w/ &quot;proxy:&quot;, so add after that */</span></span><br><span class="line">             memmove(r-&gt;filename+<span class="number">6</span>, rurl, <span class="built_in">strlen</span>(rurl)+<span class="number">1</span>);</span><br><span class="line">             <span class="comment">// è®°å½•ä¿¡æ¯</span></span><br><span class="line">             ap_log_rerror(APLOG_MARK, APLOG_TRACE2, <span class="number">0</span>, r,</span><br><span class="line">                     <span class="string">&quot;*: rewrite of url due to UDS(%s): %s (%s)&quot;</span>,</span><br><span class="line">                     sockpath, *url, r-&gt;filename);</span><br><span class="line">         &#125;</span><br><span class="line">    </span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">             *ptr = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    </span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“åˆæ³¨è§£ï¼Œå¯ä»¥çœ‹å‡º <code>fix_uds_filename</code> è¿™ä¸ªå‡½æ•°æœ¬èº«å°±æ˜¯ç”¨äºè§£æå¹¶å¡«å†™ uri ï¼Œæ–‡ä»¶åæ ‡è¯† UDS ï¼Œç„¶åé€šè¿‡ç®¡é“ç¬¦ <code>|</code> åé¢çš„å†…å®¹é‡å®šå‘åˆ°å®ƒã€‚</p>
<p>å¯¹æ¯” COND2 å’Œ *COND2 ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ¼æ´çš„ä¿®å¤å°±æ˜¯å•çº¯å¼ºåˆ¶è¦æ±‚ <code>proxy:unix:</code> å¼€å¤´ï¼ŒCOND2 æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºåªè¦æ˜¯æœ‰ <code>unix:</code> å­—æ ·è€Œä¸”ä¸è®ºå¤§å°å†™éƒ½èƒ½è¢«è§£æï¼Œæ˜¾ç„¶æ˜¯åˆ¤å®šå®½æ¾å‡ºäº†é—®é¢˜ï¼Œä¸ºäº†æ›´å¥½ç†è§£æˆ‘ä»¬å…ˆæ¥çœ‹ <a target="_blank" rel="noopener external nofollow noreferrer" href="https://twitter.com/_mattata/status/1449020783989297167">remyğŸ€ åœ¨ Twitter: â€œCVE-2021-40438 Apache SSRF as a one-liner./ Twitter</a> ä¸Šçš„ä¸€ä¸ª poc ï¼š</p>
<img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211214033514714.png" alt="image-20211214033514714" style="zoom: 67%;" />

<p>å¯ä»¥çœ‹åˆ° <code>unix:</code> åå®ƒæ‹¼æ¥äº†å…± 7701 ä¸ªå­—ç¬¦çš„ A ï¼Œå¯ä»¥çŒœæƒ³è¿™å…¶ä¸­ä¸€å®šæœ‰ç¼“å†²åŒºæˆ–è€…é”™è¯¯å¤„ç†çš„é—®é¢˜ï¼Œæ¥çœ‹ä¿®å¤å‰æ‹¼æ¥çš„æ•ˆæœï¼Œå‡è®¾æˆ‘ä»¬å‘é€çš„è¯·æ±‚å¦‚ä¸‹ï¼Œæ˜¾ç„¶æ˜¯è®©ä»£ç†ä¸€ä¸ª http è¯·æ±‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/?unix:$(python3 -c &#x27;print(&quot;A&quot;*7701, end=&quot;&quot;)&#x27;)|http://backend_server1:8085/</span><br></pre></td></tr></table></figure>

<p>ä»£ç†è¯·æ±‚æ‹¼æ¥åï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy:http://localhost/?unix:$(python3 -c &#x27;print(&quot;A&quot;*7701, end=&quot;&quot;)&#x27;)|http://backend_server1:8085/</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±åˆå› ä¸ºåŒ…å« <code>unix:</code> ï¼Œæ»¡è¶³ COND2 ï¼Œ<strong>å°±ä» http è¯·æ±‚å˜æˆäº†æœ‰æ•ˆçš„ UDS ä»£ç†é‡å®šå‘è¯·æ±‚ã€‚</strong></p>
<p>è§£é‡Šåˆ°è¿™ï¼Œæˆ‘ä»¬æ˜ç™½é—®é¢˜æœ¬è´¨åï¼Œå…ˆæ¥åˆ†æä»€ä¹ˆæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå†æ¥ä» UDS è§£æè¿‡ç¨‹ä¸Šåˆ†æä¸ºä»€ä¹ˆè¦æ‹¼æ¥å°†è¿‘ 7000 ä¸ªå­—ç¬¦æ‰èƒ½æ”»å‡»æˆåŠŸã€‚</p>
<h4 id="å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ"><a href="#å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ" class="headerlink" title="å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ"></a>å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ</h4><p>ä¹‹å‰åœ¨å‰ç½®çŸ¥è¯†å­¦ä¹ ä¸­ï¼Œç¬”è€…æœ‰æåˆ°è¿‡ mod_proxy æœ‰å®ƒå¤„ç†è¯·æ±‚çš„ Handlerï¼Œæˆ‘ä»¬ä»è¿™ä¸ªå‡½æ•°æ¥çœ‹å“ªäº›æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå½“ç„¶ï¼Œè®¤çœŸçœ‹äº†ä¸Šéƒ¨åˆ†å†…å®¹çš„ä½ ï¼Œä¸€å®šçŸ¥é“ <code>r-&gt;filename</code> æ˜¯å…³é”®ã€‚</p>
<p>modules/proxy/mod_proxy_http.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ap_proxy_http_register_hook</span><span class="params">(<span class="keyword">apr_pool_t</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ap_hook_post_config(proxy_http_post_config, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_MIDDLE);</span><br><span class="line">    proxy_hook_scheme_handler(proxy_http_handler, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_FIRST);</span><br><span class="line">    proxy_hook_canon_handler(proxy_http_canon, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_FIRST);</span><br><span class="line">    warn_rx = ap_pregcomp(p, <span class="string">&quot;[0-9]&#123;3&#125;[ \t]+[^ \t]+[ \t]+\&quot;[^\&quot;]*\&quot;([ \t]+\&quot;([^\&quot;]+)\&quot;)?&quot;</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ª hookï¼Œæˆ‘ä»¬æ¥çœ‹ <code>proxy_http_canon</code> è¿™ä¸ª Handlerï¼Œæ˜¯ç”¨äºå¤„ç†åä»£è¯·æ±‚çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">proxy_http_canon</span><span class="params">(request_rec *r, <span class="keyword">char</span> *url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get_url_scheme æ˜¯æ£€æŸ¥è¯¥è¯·æ±‚æ˜¯å¦æ˜¯ï¼ˆh / H å¼€å¤´ï¼‰ å†åˆ¤æ–­æ˜¯å¦æ˜¯ http / httpsï¼Œä¹Ÿå°±æ˜¯è¯¥ä¸è¯¥ç”± mod_proxy_http å¤„ç†</span></span><br><span class="line">    <span class="comment">// schema pass</span></span><br><span class="line">    scheme = get_url_scheme((<span class="keyword">const</span> <span class="keyword">char</span> **)&amp;url, &amp;is_ssl);</span><br><span class="line">    <span class="keyword">if</span> (!scheme) &#123;</span><br><span class="line">        <span class="keyword">return</span> DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    port = def_port = (is_ssl) ? DEFAULT_HTTPS_PORT : DEFAULT_HTTP_PORT;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (r-&gt;proxyreq) &#123;</span><br><span class="line">    <span class="keyword">default</span>: <span class="comment">/* wtf are we doing here? */</span></span><br><span class="line">    <span class="keyword">case</span> PROXYREQ_REVERSE:</span><br><span class="line">        <span class="keyword">if</span> (apr_table_get(r-&gt;notes, <span class="string">&quot;proxy-nocanon&quot;</span>)) &#123;</span><br><span class="line">            path = url;   <span class="comment">/* this is the raw path */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            path = ap_proxy_canonenc(r-&gt;pool, url, <span class="built_in">strlen</span>(url),</span><br><span class="line">                                     enc_path, <span class="number">0</span>, r-&gt;proxyreq);</span><br><span class="line">            search = r-&gt;args;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PROXYREQ_PROXY:</span><br><span class="line">        path = url;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> HTTP_BAD_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (port != def_port)</span><br><span class="line">        apr_snprintf(sport, <span class="keyword">sizeof</span>(sport), <span class="string">&quot;:%d&quot;</span>, port);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        sport[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// host pass</span></span><br><span class="line">    <span class="keyword">if</span> (ap_strchr_c(host, <span class="string">&#x27;:&#x27;</span>)) &#123; <span class="comment">/* if literal IPv6 address */</span></span><br><span class="line">        host = apr_pstrcat(r-&gt;pool, <span class="string">&quot;[&quot;</span>, host, <span class="string">&quot;]&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€ç»ˆæ‹¼æ¥èµ‹å€¼ç»™ r-&gt;filename</span></span><br><span class="line">    r-&gt;filename = apr_pstrcat(r-&gt;pool, <span class="string">&quot;proxy:&quot;</span>, scheme, <span class="string">&quot;://&quot;</span>, host, sport,</span><br><span class="line">                              <span class="string">&quot;/&quot;</span>, path, (search) ? <span class="string">&quot;?&quot;</span> : <span class="string">&quot;&quot;</span>, search, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“åˆæ³¨é‡Šï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆåªæœ‰ <code>path</code> å’Œ <code>search</code> æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œ<code>r-&gt;filename</code> ååŠéƒ¨åˆ†å¯æ§ä¹Ÿæ°æ°æ˜¯ <code>|</code> åçš„åç«¯åœ°å€ã€‚</p>
<h4 id="UDS-è§£æè¿‡ç¨‹"><a href="#UDS-è§£æè¿‡ç¨‹" class="headerlink" title="UDS è§£æè¿‡ç¨‹"></a>UDS è§£æè¿‡ç¨‹</h4><p>ä¹‹å‰åœ¨ä»£ç æ³¨é‡Šä¸­ä¹Ÿæåˆ°è¿‡ï¼Œ<code>uds_path</code> å°±æ˜¯ <code>unix:</code> ä¸ <code>|</code> ä¹‹é—´çš„éƒ¨åˆ†ï¼Œåœ¨ poc ä¸­å°±æ˜¯é‚£è¿‘ 7000 çš„å­—ç¬¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;pool, urisock.path);</span><br><span class="line"><span class="comment">// å°† uds_path é”®å€¼å¯¹æ·»åŠ åˆ° r-&gt;notes</span></span><br><span class="line">apr_table_setn(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>, sockpath);</span><br></pre></td></tr></table></figure>

<p>å…ˆæ¥çœ‹ <code>ap_runtime_dir_relative</code> åšäº†ä»€ä¹ˆã€‚</p>
<p>server/config.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ap_runtime_dir_relative(r-&gt;pool, urisock.path)</span></span><br><span class="line">AP_DECLARE(<span class="keyword">char</span> *) ap_runtime_dir_relative(<span class="keyword">apr_pool_t</span> *p, <span class="keyword">const</span> <span class="keyword">char</span> *file)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> *newpath = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">apr_status_t</span> rv;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *runtime_dir = ap_runtime_dir ? ap_runtime_dir : ap_server_root_relative(p, DEFAULT_REL_RUNTIMEDIR);</span><br><span class="line"></span><br><span class="line">    rv = apr_filepath_merge(&amp;newpath, runtime_dir, file,</span><br><span class="line">                            APR_FILEPATH_TRUENAME, p);</span><br><span class="line">    <span class="keyword">if</span> (newpath &amp;&amp; (rv == APR_SUCCESS || APR_STATUS_IS_EPATHWILD(rv)</span><br><span class="line">                                      || APR_STATUS_IS_ENOENT(rv)</span><br><span class="line">                                      || APR_STATUS_IS_ENOTDIR(rv))) &#123;</span><br><span class="line">        <span class="keyword">return</span> newpath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è°ƒç”¨äº† apr åº“çš„ <code>apr_filepath_merge</code> è¿™ä¸ªå‡½æ•°ã€‚</p>
<p>apr/file_io/unix/filepath.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apr_filepath_merge(&amp;newpath, runtime_dir, file,APR_FILEPATH_TRUENAME, p)</span></span><br><span class="line">APR_DECLARE(<span class="keyword">apr_status_t</span>) apr_filepath_merge(<span class="keyword">char</span> **newpath,</span><br><span class="line">                                             <span class="keyword">const</span> <span class="keyword">char</span> *rootpath,</span><br><span class="line">                                             <span class="keyword">const</span> <span class="keyword">char</span> *addpath,</span><br><span class="line">                                             <span class="keyword">apr_int32_t</span> flags,</span><br><span class="line">                                             <span class="keyword">apr_pool_t</span> *p)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    rootlen = <span class="built_in">strlen</span>(rootpath);</span><br><span class="line">    maxlen = rootlen + <span class="built_in">strlen</span>(addpath) + <span class="number">4</span>; <span class="comment">/* 4 for slashes at start, after</span></span><br><span class="line"><span class="comment">                                             * root, and at end, plus trailing</span></span><br><span class="line"><span class="comment">                                             * null */</span></span><br><span class="line">    <span class="keyword">if</span> (maxlen &gt; APR_PATH_MAX) &#123;</span><br><span class="line">        <span class="keyword">return</span> APR_ENAMETOOLONG;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>apr_filepath_merge</code> è¿™ä¸ªå‡½æ•°ç®€å•æè¿°å°±æ˜¯å°† <code>addpath</code> åˆå¹¶åˆ°é¢„å…ˆå¤„ç†çš„ <code>rootpath</code> ä¸Šï¼Œåœ¨è¿™é‡Œå°±æ˜¯ <code>file</code> åˆå¹¶åˆ° <code>runtime_dir</code> ã€‚</p>
<p>å¯¹çœç•¥çš„éƒ¨åˆ†è§£é‡Šä¸€ä¸‹ï¼Œè¿™é‡Œçš„ <code>flags</code> å› ä¸ºæ˜¯ <code>APR_FILEPATH_TRUENAME</code>ï¼ˆè¿™æ˜¯åˆå¹¶çš„è§„åˆ™ï¼‰ï¼Œæµç¨‹å¤§æ¦‚å°±æ˜¯æ£€æŸ¥ <code>file</code> è¿™ä¸ª <code>addpath</code> æ˜¯å¦åŒ…å«ä¸€äº›å¹³å°ä¸æ”¯æŒçš„é€šé…ç¬¦ï¼ˆ <code>*</code> ã€<code>?</code>ï¼‰ï¼Œå…¶ä»–æƒ…å†µæ˜¯å¤„ç†ç»å¯¹ / ç›¸å¯¹è·¯å¾„çš„ä¸€äº›è§„åˆ™ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆªå–å‡ºæ¥çš„éƒ¨åˆ†ï¼Œå¦‚æœ <code>maxlen</code> ä¹Ÿå°±æ˜¯ <code>rootpath</code> å’Œ <code>addpath</code> é•¿åº¦ + 4 å¦‚æœå¤§äº <code>APR_PATH_MAX</code>ï¼ˆ linux ä¸ win ä¸åŒï¼Œæ˜¯4096ï¼‰ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ª <code>APR_ENAMETOOLONG</code> çš„é”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯èµ‹å€¼ç»™ <code>rv</code> ï¼Œåœ¨ <code>ap_runtime_dir_relative</code> ä¸­æ˜¯æœ€åä¼šè¿›å…¥ else åˆ†æ”¯ <strong>return NULL</strong> çš„ã€‚</p>
<p>ä¹‹ååœ¨ modules/proxy/proxy_util.c ä¸­ <code>ap_proxy_determine_connection</code> ç¡®å®šåç«¯ä¸»æœºåå’Œç«¯å£ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">PROXY_DECLARE(<span class="keyword">int</span>)</span><br><span class="line">ap_proxy_determine_connection(<span class="keyword">apr_pool_t</span> *p, request_rec *r,</span><br><span class="line">                              proxy_server_conf *conf,</span><br><span class="line">                              proxy_worker *worker,</span><br><span class="line">                              proxy_conn_rec *conn,</span><br><span class="line">                              <span class="keyword">apr_uri_t</span> *uri,</span><br><span class="line">                              <span class="keyword">char</span> **url,</span><br><span class="line">                              <span class="keyword">const</span> <span class="keyword">char</span> *proxyname,</span><br><span class="line">                              <span class="keyword">apr_port_t</span> proxyport,</span><br><span class="line">                              <span class="keyword">char</span> *server_portstr,</span><br><span class="line">                              <span class="keyword">int</span> server_portstr_size)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// è¿˜è®°å¾—ä¹‹å‰æœ‰è¿™å¥ apr_table_setn(r-&gt;notes, &quot;uds_path&quot;, sockpath); å°† uds_path é”®å€¼å¯¹æ·»åŠ åˆ° r-&gt;notes å—ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå°±æ˜¯åœ¨æ£€éªŒ uds_path çš„å€¼</span></span><br><span class="line">    uds_path = (*worker-&gt;s-&gt;uds_path ? worker-&gt;s-&gt;uds_path : apr_table_get(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (uds_path) &#123;</span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;uds_path == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">/* use (*conn)-&gt;pool instead of worker-&gt;cp-&gt;pool to match lifetime */</span></span><br><span class="line">            conn-&gt;uds_path = apr_pstrdup(conn-&gt;pool, uds_path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;uds_path) &#123;</span><br><span class="line">            ap_log_rerror(APLOG_MARK, APLOG_DEBUG, <span class="number">0</span>, r, APLOGNO(<span class="number">02545</span>)</span><br><span class="line">                         <span class="string">&quot;%s: has determined UDS as %s&quot;</span>,</span><br><span class="line">                         uri-&gt;scheme, conn-&gt;uds_path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* should never happen */</span></span><br><span class="line">            ap_log_rerror(APLOG_MARK, APLOG_DEBUG, <span class="number">0</span>, r, APLOGNO(<span class="number">02546</span>)</span><br><span class="line">                         <span class="string">&quot;%s: cannot determine UDS (%s)&quot;</span>,</span><br><span class="line">                         uri-&gt;scheme, uds_path);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * In UDS cases, some structs are NULL. Protect from de-refs</span></span><br><span class="line"><span class="comment">         * and provide info for logging at the same time.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!conn-&gt;addr) &#123;</span><br><span class="line">            <span class="keyword">apr_sockaddr_t</span> *sa;</span><br><span class="line">            apr_sockaddr_info_get(&amp;sa, <span class="literal">NULL</span>, APR_UNSPEC, <span class="number">0</span>, <span class="number">0</span>, conn-&gt;pool);</span><br><span class="line">            conn-&gt;addr = sa;</span><br><span class="line">        &#125;</span><br><span class="line">        conn-&gt;hostname = <span class="string">&quot;httpd-UDS&quot;</span>;</span><br><span class="line">        conn-&gt;port = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹ç…§æ³¨é‡Šï¼Œå¦‚æœæˆ‘ä»¬å‘é€è¶…é•¿å­—ç¬¦ï¼Œå¯¼è‡´ <code>uds_path</code> ä¸º <code>NULL</code> çš„è¯ï¼Œå°±ä¼šè¿›å…¥ else åˆ†æ”¯ï¼Œå®ƒä»¬å…·ä½“å¤„ç†å¤§è‡´æ˜¯è¿™æ ·ä¸€ä¸ªæƒ…å†µï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (uds_path) &#123; </span><br><span class="line">    <span class="comment">// Prepare UDS requestâ€¦</span></span><br><span class="line">    <span class="comment">// ç”¨ UDS ç»§ç»­é€šä¿¡</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Prepare standard proxy requestâ€¦</span></span><br><span class="line">    <span class="comment">// è½¬è€Œç”¨ TCP é€šä¿¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç»“åˆæ‰€æœ‰å†…å®¹å°±å¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œè¿›å…¥ else åˆ†æ”¯æŠŠè¯·æ±‚æœ€ç»ˆè§£é‡Šæˆäº†æ ‡å‡†ä»£ç†è¯·æ±‚å¦‚ http://<SSRF_TARGET> ï¼Œå°±å¯¼è‡´äº†å¯ä»¥å‘å†…éƒ¨ç½‘ç»œä»»æ„ Apache æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè¯·æ±‚æ‰§è¡ŒæˆåŠŸï¼ŒSSRF è§¦å‘ã€‚</p>
<h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>æœ‰æ—¶ä¼šæŠ¥ 503 çš„é”™è¯¯ï¼Œå¤šè¯•å‡ æ¬¡å°±è¡Œäº†ã€‚</p>
<img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211215041523606.png" alt="image-20211215041523606" style="zoom:80%;" />

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://cwiki.apache.org/confluence/display/HTTPD/PHP-FPM">PHP-FPM - HTTPD - Apache Software Foundation</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/xuey/p/10059050.html">PHP äº”å¤§è¿è¡Œæ¨¡å¼ - é›ªå‰‘æ— å½± - åšå®¢å›­ (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/tssc/p/10255590.html#_label2_0">å…³äºCGIå’ŒFastCGIçš„ç†è§£ - å¤©ç”Ÿå¸…æ‰ - åšå®¢å›­ (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.fujieace.com/php/modes.html">PHPè¿è¡Œæ¨¡å¼æœ‰å“ªå‡ ç§ï¼Ÿ - ä»˜æ°åšå®¢ (fujieace.com)</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/yueyecheshou1980/article/details/106227285/">Apache httpd ä½¿ç”¨ mod_proxy_fcgiçš„æ–¹å¼php-fpm_yueyecheshou1980çš„åšå®¢-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/liuxinyustu/articles/10399883.html">APACHE PHPçš„å‡ ç§è¿è¡Œæ–¹å¼ï¼ˆCGI,FASTCGIï¼‰ - liuxinyu123 - åšå®¢å›­ (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.iteye.com/blog/tcspecial-2070075">Fastcgi FastCgiExternalServer mod_proxy - äº‘æ·¡é£æ¸… - ITeyeåšå®¢</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://httpd.apache.org/docs/trunk/mod/mod_proxy.html">mod_proxy - Apache HTTP Server Version 2.5</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__CONFIG.html#gaff5ad1f7fa1d04009c2697453324e93e">Apache2: Configuration</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/developer-modguide.html">Apache ä¸­æ–‡æ–‡æ¡£ - ä¸º Apache HTTP Server 2.4 å¼€å‘æ¨¡å— | Docs4dev</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://baijiahao.baidu.com/s?id=1659476214623211564&wfr=spider&for=pc">PHPè¿è¡Œæ–¹å¼ä»‹ç» (baidu.com)</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://firzen.de/building-a-poc-for-cve-2021-40438">Building a POC for CVE-2021-40438 â€“ Firzens Blog</a></p>
<p>[<a target="_blank" rel="noopener external nofollow noreferrer" href="https://koromoon.blogspot.com/2021/12/cve-2021-40438-apache-http-server.html">CVE-2021-40438] Apache HTTP Server mod_proxy SSRF Vulnerability - KOROMOON</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://cydrill.com/owasp/apache-ssrf-an-all-you-can-eat-reverse-proxy/">Apache SSRF: an all-you-can-eat reverse proxy &gt; Cydrill Software Security</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.lionic.com/news/2021/12/05/multiple-vulnerabilities-in-recent-apache-web-server/">Multiple Vulnerabilities in recent Apache Web Server | LIONIC-é´»ç’Ÿç§‘æŠ€</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html#">Apache mod_proxy SSRFï¼ˆCVE-2021-40438ï¼‰çš„ä¸€ç‚¹åˆ†æå’Œå»¶ä¼¸ | ç¦»åˆ«æ­Œ (leavesongs.com)</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://47.98.250.156/2021/10/25/CVE-2021-40438/">CVE-2021-40438 | 0pa9ue</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">snovving</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://snovving.top/posts/368b3bb7/">https://snovving.top/posts/368b3bb7/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://snovving.top" target="_blank">snovving</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SSRF/">SSRF</a><a class="post-meta__tags" href="/tags/Apache/">Apache</a><a class="post-meta__tags" href="/tags/mod-proxy/">mod_proxy</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://blog-img-1308029004.cos.ap-shanghai.myqcloud.com/1640695032538.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">snovving</div><div class="author-info__description">æŠµè¾¾ç»ˆç‚¹ï¼Œæ‚¬è€Œæœªå†³ã€‚</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">14</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/snovving"><i class="fab fa-github"></i><span>Come with Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://twitter.com/snovving1" rel="external nofollow noreferrer" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="mailto:snovving@yahoo.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="http://snovving.top/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">ç®€ä»‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">2.1.</span> <span class="toc-text">æ¼æ´æˆå› </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">2.2.</span> <span class="toc-text">å½±å“ç‰ˆæœ¬</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">2.3.</span> <span class="toc-text">å®éªŒç¯å¢ƒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%AD%A6%E4%B9%A0"><span class="toc-number">3.</span> <span class="toc-text">å‰ç½®å­¦ä¹ </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-%E9%83%A8%E7%BD%B2-php"><span class="toc-number">3.1.</span> <span class="toc-text">Apache éƒ¨ç½² php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mod-proxy-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">mod_proxy åå‘ä»£ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-hook-%E6%9C%BA%E5%88%B6"><span class="toc-number">3.3.</span> <span class="toc-text">Apache hook æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">4.1.</span> <span class="toc-text">ä»£ç å®¡è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%AA%E9%83%A8%E5%88%86%E6%98%AF%E5%8F%AF%E6%8E%A7%E7%9A%84%EF%BC%9F"><span class="toc-number">4.1.1.</span> <span class="toc-text">å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDS-%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">4.1.2.</span> <span class="toc-text">UDS è§£æè¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">æ¼æ´åˆ©ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">å‚è€ƒ</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/368b3bb7/" title="CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ">CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ</a><time datetime="2021-11-21T11:30:00.000Z" title="å‘è¡¨äº 2021-11-21 19:30:00">2021-11-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/bb793f41/" title="CVE-2021-37580 Apache ShenYu JWT è®¤è¯ç¼ºé™·æ¼æ´åˆ†æ">CVE-2021-37580 Apache ShenYu JWT è®¤è¯ç¼ºé™·æ¼æ´åˆ†æ</a><time datetime="2021-11-20T12:40:22.000Z" title="å‘è¡¨äº 2021-11-20 20:40:22">2021-11-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/63c2921e/" title="æ©™å…‰ V2.31.284.0923 å†…è´­ä»»æ„è®¢å•ä¿®æ”¹æ¼æ´">æ©™å…‰ V2.31.284.0923 å†…è´­ä»»æ„è®¢å•ä¿®æ”¹æ¼æ´</a><time datetime="2021-11-18T14:30:00.000Z" title="å‘è¡¨äº 2021-11-18 22:30:00">2021-11-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/f5e7bdc4/" title="ä» hxp 2020 ä¸€é“é¢˜æ¥çœ‹åˆ©ç”¨ ftp ä¸ php-fpm å¯¹è¯ RCE">ä» hxp 2020 ä¸€é“é¢˜æ¥çœ‹åˆ©ç”¨ ftp ä¸ php-fpm å¯¹è¯ RCE</a><time datetime="2021-10-30T12:20:00.000Z" title="å‘è¡¨äº 2021-10-30 20:20:00">2021-10-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/608ab632/" title="CVE-2021-3129 Laravel Debug mode è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ">CVE-2021-3129 Laravel Debug mode è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ</a><time datetime="2021-10-30T12:00:00.000Z" title="å‘è¡¨äº 2021-10-30 20:00:00">2021-10-30</time></div></div></div></div></div></div></main><footer id="footer" style="background: #88878f"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By snovving</div><div class="footer_custom_text">Winter is coming.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'blog-2ghr66qp8b425638',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'blog-2ghr66qp8b425638',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>